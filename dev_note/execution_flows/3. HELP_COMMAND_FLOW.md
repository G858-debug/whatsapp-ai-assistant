# Help Command Flow

## Complete Flow Path

```
[User sends "/help" command or clicks "ðŸ“š Show Help" button]
1. routes/webhooks.py (whatsapp_webhook)
   â†“ text="/help" OR interactive.button_reply.id="/help"
2. services/message_router/message_router.py (route_message)
   â†“ detects command starts with '/'
   â†“ checks universal commands first
3. services/message_router/handlers/universal_command_handler.py (handle_universal_command)
   â†“ cmd == '/help'
4. services/commands/common/help_command.py (handle_help)
   â†“ gets login_status from auth_service
   â†“ builds role-specific help menu
   â†“ [Sends WhatsApp List Message with command categories]

[User clicks a category (e.g., "Account Management")]
5. routes/webhooks.py (whatsapp_webhook)
   â†“ interactive_type="list_reply", list_reply.id="help_account"
6. services/message_router/message_router.py (route_message)
   â†“ button_id="help_account" detected
7. services/message_router/handlers/buttons/button_handler.py (handle_button_response)
   â†“ matches pattern button_id.startswith('help_')
8. services/message_router/handlers/buttons/button_handler.py (_handle_help_category)
   â†“ gets role from auth_service
   â†“ looks up category buttons
   â†“ [Sends button message with 3 command buttons]

[User clicks a command button (e.g., "ðŸ‘¤ View Profile")]
9. routes/webhooks.py (whatsapp_webhook)
   â†“ interactive.button_reply.id="/view-profile"
10. services/message_router/message_router.py (route_message)
    â†“ button_id="/view-profile" detected
11. services/message_router/handlers/buttons/button_handler.py (handle_button_response)
    â†“ detects button_id.startswith('/')
12. services/message_router/handlers/buttons/button_handler.py (_handle_command_button)
    â†“ checks if universal command first
    â†“ if not, routes to logged_in_user_handler
13. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_button)
    â†“ routes to role_command_handler
14. services/message_router/handlers/commands/role_command_handler.py (handle_role_command)
    â†“ executes the command
```

## Key Context Points

**Message Types:**

- `text` â†’ Command message (e.g., "/help")
- `interactive.list_reply` â†’ Category selection (list_reply.id: "help_account", "help_clients", etc.)
- `interactive.button_reply` â†’ Command button click (button_id: "/view-profile", "/create-habit", etc.)

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` â†’ Prevents duplicate webhooks
- `users (dev_note\current_schemas\users.sql)` â†’ Gets login_status to determine role

**Help Categories (Trainer - 7 categories):**

- `help_account` â†’ Account Management (view profile, edit profile, delete account, logout, switch role)
- `help_clients` â†’ Client Management (invite client, create client, view clients, remove client)
- `help_habits` â†’ Habit Management (create habit, edit habit, delete habit, view habits)
- `help_assign` â†’ Habit Assignment (assign habit, unassign habit, view client habits)
- `help_progress` â†’ Progress Tracking (view client progress, weekly report, monthly report)
- `help_dashboard` â†’ Dashboard & Reports (trainer dashboard, export habit data)
- `help_system` â†’ System Commands (help, stop task, register)

**Help Categories (Client - 6 categories):**

- `help_account` â†’ Account Management (view profile, edit profile, delete account)
- `help_trainers` â†’ Trainer Management (search trainers, invite trainer, view trainers, remove trainer)
- `help_habits` â†’ Habit Tracking (view my habits, log habits, view progress)
- `help_reports` â†’ Progress Reports (weekly report, monthly report)
- `help_reminders` â†’ Reminders (reminder settings, test reminder)
- `help_system` â†’ System Commands (help, stop task)

**Command Button Mapping (Trainer):**

- Account: `/view-profile`, `/edit-profile`, `/logout`
- Clients: `/invite-trainee`, `/view-trainees`, `/remove-trainee`
- Habits: `/create-habit`, `/edit-habit`, `/view-habits`
- Assign: `/assign-habit`, `/unassign-habit`
- Progress: `/view-trainee-progress`, `/trainee-weekly-report`
- Dashboard: `/trainer-dashboard`, `/view-habits`

**Command Button Mapping (Client):**

- Account: `/view-profile`, `/edit-profile`, `/delete-account`
- Trainers: `/search-trainer`, `/view-trainers`, `/remove-trainer`
- Habits: `/view-my-habits`, `/log-habits`, `/view-progress`
- Reports: `/weekly-report`, `/monthly-report`
- Reminders: `/reminder-settings`, `/test-reminder`

**Universal Commands:**

- `/help` â†’ Works in any authentication state
- `/stop` â†’ Works in any authentication state
- `/register` â†’ Only for non-logged-in users

**Key Functions:**

- `handle_help()` â†’ Main help command handler
- `_handle_help_category()` â†’ Shows command buttons for selected category
- `_handle_command_button()` â†’ Routes command buttons to appropriate handlers
- `handle_universal_command()` â†’ Checks if command is universal before role routing

**Authentication Flow:**

- `auth_service.get_login_status(phone)` â†’ Returns role string ('trainer', 'client', or None)
- Universal commands work without login
- Role-specific commands require login

**Button Limit:**

- WhatsApp List Messages: Max 10 rows total across all sections
- WhatsApp Button Messages: Max 3 buttons per message
- Help uses both: List for categories, Buttons for commands

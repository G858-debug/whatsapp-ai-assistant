# View Profile Flow

## Complete Flow Path

```
[User sends "/view-profile" command]
1. routes/webhooks.py (whatsapp_webhook)
   â†“ text="/view-profile"
2. services/message_router/message_router.py (route_message)
   â†“ user exists, logged in as 'trainer' or 'client'
3. services/message_router/handlers/buttons/button_handler.py (handle_logged_in_message)
   â†“ routes to logged_in_user_handler
4. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   â†“ detects command starts with '/'
5. services/message_router/handlers/commands/role_command_handler.py (handle_role_command)
   â†“ checks common commands first
6. services/message_router/handlers/commands/common_commands.py (handle_common_command)
   â†“ cmd == '/view-profile'
7. services/commands/common/profile_commands.py (handle_view_profile)
   â†“ creates ProfileViewer instance
8. services/profile_viewer/profile_viewer.py (show_profile_menu)
   â†“ queries database for profile data
   â†“ [Sends WhatsApp List Message with profile sections]

[User clicks a section (e.g., "ðŸ“‹ Basic Information")]
9. routes/webhooks.py (whatsapp_webhook)
   â†“ interactive_type="list_reply", list_reply.id="view_basic_info"
10. services/message_router/message_router.py (route_message)
    â†“ button_id="view_basic_info" detected
11. services/message_router/handlers/buttons/button_handler.py (handle_button_response)
    â†“ matches pattern button_id.startswith('view_')
12. services/message_router/handlers/buttons/button_handler.py (_handle_profile_view_button)
    â†“ gets role and user_id from auth_service
13. services/profile_viewer/profile_viewer.py (show_profile_section)
    â†“ queries database for profile data
    â†“ builds section content based on section_id
    â†“ [Sends formatted section with navigation buttons]
```

## Key Context Points

**Message Types:**

- `text` â†’ Command message (e.g., "/view-profile")
- `interactive.list_reply` â†’ List selection (list_reply.id: "view_basic_info", "view_business_details", etc.)
- `interactive.button_reply` â†’ Button click (button_id: "/view-profile", "back_to_profile")

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` â†’ Prevents duplicate webhooks
- `users (dev_note\current_schemas\users.sql)` â†’ Gets login_status, trainer_id/client_id
- `trainers (dev_note\current_schemas\trainers.sql)` â†’ Trainer profile data (queried by trainer_id)
- `clients (dev_note\current_schemas\clients.sql)` â†’ Client profile data (queried by client_id)

**Profile Sections (Trainer):**

- `view_basic_info` â†’ Name, email, location, birthday
- `view_business_details` â†’ Business name, specializations, experience, pricing
- `view_availability` â†’ Weekly schedule (working_hours JSONB)
- `view_services` â†’ Services offered, subscription plan, pricing flexibility

**Profile Sections (Client):**

- `view_basic_info` â†’ Name, email, contact details
- `view_fitness_goals` â†’ Fitness objectives
- `view_health_info` â†’ Experience level, health conditions
- `view_preferences` â†’ Availability, training preferences

**Key Functions:**

- `ProfileViewer._get_profile_data()` â†’ Queries trainers/clients table by trainer_id/client_id
- `ProfileViewer._build_trainer_section()` â†’ Formats trainer section content
- `ProfileViewer._build_client_section()` â†’ Formats client section content
- `ProfileViewer._format_list_value()` â†’ Handles array/list field formatting

**Authentication Flow:**

- `auth_service.get_login_status(phone)` â†’ Returns role string ('trainer' or 'client')
- `auth_service.get_user_id_by_role(phone, role)` â†’ Returns trainer_id or client_id
- Both IDs are custom format (e.g., TR_ASRA_111, CL_JOHN_222)

**Fallback Mechanism:**

- Primary: Query by trainer_id/client_id
- Fallback: Query by whatsapp phone number (for data integrity issues)

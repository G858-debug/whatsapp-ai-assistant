# View Profile Flow

## Complete Flow Path

```
[User sends "/view-profile" command]
1. routes/webhooks.py â†’ whatsapp_webhook()
   â†“ text="/view-profile"

2. services/message_router/message_router.py â†’ route_message()
   â†“
   â†“ STEP 3: Check if user exists
   â†“ â”œâ”€ FOR /view-profile: user = user_manager.check_user_exists(phone)
   â†“ â””â”€ RESULT: User exists, continue to STEP 4
   â†“
   â†“ STEP 4: Check login status
   â†“ â”œâ”€ if not login_status â†’ _try_auto_login(phone, user)
   â†“ â”‚  â”œâ”€ checks: if user has only one role (trainer_id XOR client_id)
   â†“ â”‚  â”œâ”€ if yes â†’ auto-login to that role
   â†“ â”‚  â””â”€ if no â†’ user needs to choose role (not applicable for /view-profile)
   â†“ â””â”€ RESULT: login_status = 'trainer' or 'client', continue to STEP 5
   â†“
   â†“ STEP 5: User is logged in
   â†“ calls: button_handler.handle_logged_in_message(phone, "/view-profile", login_status)
   â†“ â””â”€ RESULT: Routes to logged_in_user_handler (STEP 3 below)

3. services/message_router/handlers/logged_in_user_handler.py â†’ handle_logged_in_user()
   â†“ checks: if message.startswith('/')
   â†“ gets: user_id = auth_service.get_user_id_by_role(phone, role)
   â†“ calls: role_command_handler.handle_role_command(phone, message, role, user_id)

4. services/message_router/handlers/commands/role_command_handler.py â†’ handle_role_command()
   â†“ cmd = command.lower().strip()
   â†“ calls: common_handler.handle_common_command(phone, cmd, role, user_id)

5. services/message_router/handlers/commands/common_commands.py â†’ handle_common_command()
   â†“ checks: if cmd == '/view-profile'
   â†“ calls: _handle_view_profile(phone, role, user_id)
   â†“ imports: from services.commands import handle_view_profile
   â†“ calls: handle_view_profile(phone, role, user_id, db, whatsapp, None)

6. services/commands/common/profile_commands.py â†’ handle_view_profile()
   â†“ imports: from services.profile_viewer import ProfileViewer
   â†“ creates: viewer = ProfileViewer(db, whatsapp)
   â†“ calls: viewer.show_profile_menu(phone, role, user_id)

7. services/profile_viewer/profile_viewer.py â†’ show_profile_menu()
   â†“ calls: profile_data = self._get_profile_data(role, user_id)
   â†“ queries: db.table(table).select('*').eq(id_column, user_id).execute()
   â†“ builds: list_message with sections (view_basic_info, view_business_details, etc.)
   â†“ calls: whatsapp.send_list_message(phone, header, body, button_text, sections)
   â†“ [Sends WhatsApp List Message with profile sections]

[User clicks a section (e.g., "ðŸ“‹ Basic Information")]
8. routes/webhooks.py â†’ whatsapp_webhook()
   â†“ interactive_type="list_reply", list_reply.id="view_basic_info"

9. services/message_router/message_router.py â†’ route_message()
   â†“ extracts: button_id = message['interactive']['list_reply']['id']
   â†“ calls: button_handler.handle_button_response(phone, button_id)

10. services/message_router/handlers/buttons/button_handler.py â†’ handle_button_response()
    â†“ checks: if button_id.startswith('view_') or button_id == 'back_to_profile'
    â†“ calls: _handle_profile_view_button(phone, button_id)

11. services/message_router/handlers/buttons/button_handler.py â†’ _handle_profile_view_button()
    â†“ gets: role = auth_service.get_login_status(phone)
    â†“ gets: user_id = auth_service.get_user_id_by_role(phone, role)
    â†“ creates: profile_viewer = ProfileViewer(db, whatsapp)
    â†“ checks: if button_id == 'back_to_profile' â†’ show_profile_menu()
    â†“ checks: if button_id.startswith('view_') â†’ show_profile_section()
    â†“ calls: profile_viewer.show_profile_section(phone, role, user_id, button_id)

12. services/profile_viewer/profile_viewer.py â†’ show_profile_section()
    â†“ calls: profile_data = self._get_profile_data(role, user_id)
    â†“ queries: db.table(table).select('*').eq(id_column, user_id).execute()
    â†“ calls: section_content = self._build_trainer_section(section_id, profile_data)
    â†“        OR section_content = self._build_client_section(section_id, profile_data)
    â†“ builds: button message with [Back to Profile Menu] button
    â†“ calls: whatsapp.send_button_message(phone, section_content, buttons)
    â†“ [Sends formatted section with navigation buttons]
```

## Key Context Points

**Message Types:**

- `text` â†’ Command message (e.g., "/view-profile")
- `interactive.list_reply` â†’ List selection (list_reply.id: "view_basic_info", "view_business_details", etc.)
- `interactive.button_reply` â†’ Button click (button_id: "/view-profile", "back_to_profile")

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` â†’ Prevents duplicate webhooks
- `users (dev_note\current_schemas\users.sql)` â†’ Gets login_status, trainer_id/client_id
- `trainers (dev_note\current_schemas\trainers.sql)` â†’ Trainer profile data (queried by trainer_id)
- `clients (dev_note\current_schemas\clients.sql)` â†’ Client profile data (queried by client_id)

**Profile Sections (Trainer):**

- `view_basic_info` â†’ Name, email, location, birthday
- `view_business_details` â†’ Business name, specializations, experience, pricing
- `view_availability` â†’ Weekly schedule (working_hours JSONB)
- `view_services` â†’ Services offered, subscription plan, pricing flexibility

**Profile Sections (Client):**

- `view_basic_info` â†’ Name, email, contact details
- `view_fitness_goals` â†’ Fitness objectives
- `view_health_info` â†’ Experience level, health conditions
- `view_preferences` â†’ Availability, training preferences

**Key Functions:**

- `ProfileViewer._get_profile_data()` â†’ Queries trainers/clients table by trainer_id/client_id
- `ProfileViewer._build_trainer_section()` â†’ Formats trainer section content
- `ProfileViewer._build_client_section()` â†’ Formats client section content
- `ProfileViewer._format_list_value()` â†’ Handles array/list field formatting

**Authentication Flow:**

- `auth_service.get_login_status(phone)` â†’ Returns role string ('trainer' or 'client')
- `auth_service.get_user_id_by_role(phone, role)` â†’ Returns trainer_id or client_id
- Both IDs are custom format (e.g., TR_ASRA_111, CL_JOHN_222)

**Fallback Mechanism:**

- Primary: Query by trainer_id/client_id
- Fallback: Query by whatsapp phone number (for data integrity issues)

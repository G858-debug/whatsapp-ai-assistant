# Profile Commands Flow (View, Edit, Delete)

## 1. VIEW PROFILE FLOW

```
[Logged-in user types "/view-profile"]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="/view-profile"
2. services/message_router/message_router.py (route_message)
   ↓ user logged in, has role
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   ↓ message starts with "/"
4. services/message_router/handlers/role_command_handler.py (handle_role_command)
   ↓ checks common commands first
5. services/message_router/handlers/commands/common_commands.py (handle_common_command → _handle_view_profile)
   ↓ imports handle_view_profile
6. services/commands/common/profile_commands.py (handle_view_profile)
   ↓ queries users table + trainers/clients table
   ↓ formats profile data
   ↓ [Sends formatted profile message]
```

**Key Points:**

- Queries `users` table by phone_number
- Queries `trainers` or `clients` table by user_id
- Formats profile with `_format_trainer_profile()` or `_format_client_profile()`
- Sends profile message with "Type /edit-profile to update" footer

---

## 2. EDIT PROFILE FLOW

### Part A: Start Edit Profile

```
[Logged-in user types "/edit-profile"]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="/edit-profile"
2. services/message_router/message_router.py (route_message)
   ↓ user logged in, has role
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   ↓ message starts with "/"
4. services/message_router/handlers/role_command_handler.py (handle_role_command)
   ↓ checks common commands first
5. services/message_router/handlers/commands/common_commands.py (handle_common_command → _handle_edit_profile)
   ↓ imports handle_edit_profile
6. services/commands/common/profile_commands.py (handle_edit_profile)
   ↓ gets registration fields from reg_service
   ↓ queries current profile data
   ↓ builds numbered field list with current values
   ↓ creates task: task_type='edit_profile', step='selecting_fields'
   ↓ [Sends field selection message]
```

### Part B: User Selects Fields to Edit

```
[User replies with field numbers: "1,3,5" or "all"]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="1,3,5"
2. services/message_router/message_router.py (route_message)
   ↓ user logged in, has running task
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   ↓ detects running task
4. services/message_router/handlers/task_handler.py (continue_task)
   ↓ task_type='edit_profile'
5. services/message_router/handlers/tasks/core_tasks.py (handle_core_task → _continue_profile_task)
   ↓ task_action='edit'
6. services/flows/profile/profile_flow.py (continue_edit_profile)
   ↓ delegates to edit_handler
7. services/flows/profile/edit_handler.py (continue_edit_profile)
   ↓ step='selecting_fields'
   ↓ _handle_field_selection()
   ↓ parses field numbers, validates
   ↓ updates task: step='editing_fields', selected_fields=[0,2,4], current_field_index=0
   ↓ _send_next_selected_field()
   ↓ [Sends first field prompt with current value]
```

### Part C: User Edits Each Field

```
[User replies with new value for field]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="New Value"
2-6. [Same routing as Part B]
7. services/flows/profile/edit_handler.py (continue_edit_profile)
   ↓ step='editing_fields'
   ↓ _handle_field_editing()
   ↓ validates field value
   ↓ stores in updates dict
   ↓ increments current_field_index
   ↓ updates task
   ↓ _send_next_selected_field()
   ↓ [Sends next field prompt OR applies updates if done]
```

### Part D: Apply Updates

```
[After all fields edited]
7. services/flows/profile/edit_handler.py (_apply_profile_updates)
   ↓ maps field names to DB columns
   ↓ handles duplicate fields (city/location, experience_years/years_experience)
   ↓ updates trainers/clients table
   ↓ completes task
   ↓ [Sends success message with "View Profile" button]
```

**Key Points:**

- Task stored with `user_id=phone` (not UUID)
- Step 1: `selecting_fields` - user picks which fields to edit
- Step 2: `editing_fields` - user edits each selected field one by one
- Validates each field value before storing
- Maps config field names to DB column names
- Handles trainer duplicate fields (city↔location, experience_years↔years_experience)

---

## 3. DELETE ACCOUNT FLOW

### Part A: Start Delete Account

```
[Logged-in user types "/delete-account"]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="/delete-account"
2. services/message_router/message_router.py (route_message)
   ↓ user logged in, has role
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   ↓ message starts with "/"
4. services/message_router/handlers/role_command_handler.py (handle_role_command)
   ↓ checks common commands first
5. services/message_router/handlers/commands/common_commands.py (handle_common_command → _handle_delete_account)
   ↓ imports handle_delete_account
6. services/commands/common/profile_commands.py (handle_delete_account)
   ↓ creates task: task_type='delete_account', confirmed=False
   ↓ checks if user has other role
   ↓ builds warning message
   ↓ [Sends confirmation request: "Reply 'YES DELETE' to confirm"]
```

### Part B: User Confirms Deletion

```
[User replies "YES DELETE"]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="YES DELETE"
2. services/message_router/message_router.py (route_message)
   ↓ user logged in, has running task
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   ↓ detects running task
4. services/message_router/handlers/task_handler.py (continue_task)
   ↓ task_type='delete_account'
5. services/message_router/handlers/tasks/core_tasks.py (handle_core_task → _continue_profile_task)
   ↓ task_action='delete'
6. services/flows/profile/profile_flow.py (continue_delete_account)
   ↓ delegates to deletion_handler
7. services/flows/profile/deletion_handler.py (continue_delete_account)
   ↓ checks message: "YES DELETE" → _execute_account_deletion()
   ↓ calls auth_service.delete_user_role()
   ↓ checks if user has other role
   ↓ completes task
   ↓ [Sends deletion confirmation message]
```

**Key Points:**

- Task stored with `user_id=phone` (not UUID)
- Requires exact text "YES DELETE" to confirm
- Accepts "CANCEL", "no", "stop" to cancel
- Calls `auth_service.delete_user_role()` which handles:
  - Deleting from trainers/clients table
  - Removing from users table (if no other role)
  - Cleaning up related data (habits, assignments, invitations)
- Shows different message if user has other role vs complete deletion

---

## Database Tables

**View Profile:**

- `users` - Gets phone_number, login_status, trainer_id/client_id
- `trainers` or `clients` - Gets profile data

**Edit Profile:**

- `users` - Gets user info
- `trainers` or `clients` - Gets current values, applies updates
- `tasks` - Stores edit_profile task with step and selected_fields

**Delete Account:**

- `users` - Checks roles, deletes if no other role
- `trainers` or `clients` - Deletes profile data
- `tasks` - Stores delete_account task with confirmed flag
- Related tables cleaned up by `auth_service.delete_user_role()`

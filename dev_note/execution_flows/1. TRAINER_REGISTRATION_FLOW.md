# Trainer Registration Flow

## Complete Flow Path

```
[User sends "hi"]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="hi"
2. services/message_router/message_router.py (route_message)
   ↓ user not found
3. services/message_router/handlers/new_user_handler.py (handle_new_user → _show_welcome_message)
   ↓ [Sends welcome + buttons: register_trainer, register_client]

[User clicks "I'm a Trainer" button]
4. routes/webhooks.py (whatsapp_webhook)
   ↓ interactive_type="button_reply", button_id="register_trainer"
5. services/message_router/message_router.py (route_message)
   ↓ button_id detected
6. services/message_router/handlers/buttons/button_handler.py (handle_button_response)
   ↓ routes to registration_handler
7. services/message_router/handlers/buttons/registration_buttons.py (_handle_register_trainer)
   ↓ creates flow handler
8. services/flows/registration/whatsapp_flow_trainer_onboarding.py (send_flow)
   ↓ [Sends WhatsApp Flow form with flow_token="trainer_onboarding_{phone}_{timestamp}"]

[User fills form and submits]
9. routes/webhooks.py (whatsapp_webhook)
   ↓ interactive_type="nfm_reply" (WhatsApp Flow response)
10. flow_handlers/flow_response_handler.py (process_flow_webhook)
    ↓ extracts flow_data, detects "trainer_onboarding" in flow_token
11. services/flows/registration/whatsapp_flow_trainer_onboarding.py (process_flow_completion)
    ↓ validates data, builds registration_data
12. services/auth/registration/data_saver.py (save_trainer_registration)
    ↓ saves to trainers + users tables
13. services/auth/core/user_manager.py (database operations)
    ↓ [Sends confirmation message]
```

## Key Context Points

**Message Types:**

- `text` → Regular text message (e.g., "hi")
- `interactive.button_reply` → Button click (button_id: "register_trainer")
- `interactive.nfm_reply` → WhatsApp Flow submission (contains flow_token + form data)

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` → Prevents duplicate webhooks
- `flow_tokens (dev_note\current_schemas\flow_tokens.sql)` → Tracks flow sessions
- `trainers (dev_note\current_schemas\trainers.sql)` → Trainer profile data
- `users (dev_note\current_schemas\users.sql)` → Links phone to trainer_id, sets login_status='trainer'

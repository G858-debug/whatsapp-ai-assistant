# Delete Account Flow

## Complete Flow Path

```
[User sends "/delete-account" command or clicks "ğŸ—‘ï¸ Delete Account" button]
1. routes/webhooks.py â†’ whatsapp_webhook()
   â†“ text="/delete-account" OR interactive.button_reply.id="/delete-account"

2. services/message_router/message_router.py â†’ route_message()
   â†“
   â†“ STEP 0: Check if button_id exists
   â†“ â”œâ”€ FOR /delete-account command: button_id = None â†’ Continue to STEP 0.1
   â†“ â””â”€ FOR button click: button_id = "/delete-account" â†’ SKIP TO STEP 4.
   â†“
   â†“ STEP 3: Check if user exists
   â†“ â”œâ”€ FOR /delete-account: user = user_manager.check_user_exists(phone)
   â†“ â”œâ”€ FOR logged-in user: user exists
   â†“ â””â”€ RESULT: Continue to STEP 4
   â†“
   â†“ STEP 4: Check login status
   â†“ â”œâ”€ FOR /delete-account: login_status = user.get('login_status')
   â†“ â”œâ”€ FOR logged-in user: login_status = 'trainer' or 'client'
   â†“ â””â”€ RESULT: Continue to STEP 5
   â†“
   â†“ STEP 5: User is logged in
   â†“ calls: button_handler.handle_logged_in_message(phone, "/delete-account", login_status)

3. services/message_router/handlers/logged_in_user_handler.py â†’ handle_logged_in_user()
   â†“ checks: if message.startswith('/') = True
   â†“ gets: user_id = auth_service.get_user_id_by_role(phone, role)
   â†“ calls: role_command_handler.handle_role_command(phone, "/delete-account", role, user_id)

4. services/message_router/handlers/commands/role_command_handler.py â†’ handle_role_command()
   â†“ cmd = command.lower().strip() = "/delete-account"
   â†“ calls: common_handler.handle_common_command(phone, cmd, role, user_id)

5. services/message_router/handlers/commands/common_commands.py â†’ handle_common_command()
   â†“ checks: if cmd == '/delete-account' = True
   â†“ calls: _handle_delete_account(phone, role, user_id)

6. services/message_router/handlers/commands/common_commands.py â†’ _handle_delete_account()
   â†“ imports: from services.commands import handle_delete_account
   â†“ calls: handle_delete_account(phone, role, user_id, db, whatsapp, auth_service)

7. services/commands/common/profile_commands.py â†’ handle_delete_account()
   â†“ builds: warning_msg with role-specific deletion consequences
   â†“ if role == 'trainer':
   â†“   adds: "Remove all trainer data, habits, assignments"
   â†“ else:
   â†“   adds: "Remove all client data, habit logs"
   â†“ calls: roles = auth_service.get_user_roles(phone)
   â†“ determines: other_role = 'client' if role == 'trainer' else 'trainer'
   â†“ checks: if roles[other_role]
   â†“   adds: "Your {other_role} account will remain active"
   â†“ else:
   â†“   adds: "Your entire account will be deleted"
   â†“ builds: buttons = [
   â†“   {"id": f"confirm_delete_{role}", "title": "âœ… Confirm Delete"},
   â†“   {"id": "cancel_delete", "title": "âŒ Cancel"}
   â†“ ]
   â†“ calls: whatsapp.send_button_message(phone, warning_msg, buttons)
   â†“ [Sends first confirmation with 2 buttons]

[User clicks "âœ… Confirm Delete" button]
8. routes/webhooks.py â†’ whatsapp_webhook()
   â†“ interactive_type="button_reply", button_reply.id="confirm_delete_trainer"

9. services/message_router/message_router.py â†’ route_message()
   â†“ STEP 0: button_id = "confirm_delete_trainer" â†’ SKIP TO button_handler

10. services/message_router/handlers/buttons/button_handler.py â†’ handle_button_response()
    â†“ checks: if button_id.startswith('confirm_delete_') or button_id == 'cancel_delete'
    â†“ calls: _handle_delete_account_button(phone, button_id)

11. services/message_router/handlers/buttons/button_handler.py â†’ _handle_delete_account_button()
    â†“ checks: if button_id == 'cancel_delete'
    â†“   sends: "Account Deletion Cancelled" message
    â†“   returns: success
    â†“ extracts: role = button_id.replace('confirm_delete_', '') = 'trainer'
    â†“ gets: login_status = auth_service.get_login_status(phone)
    â†“ validates: login_status == role
    â†“ gets: user_id = auth_service.get_user_id_by_role(phone, role)
    â†“ calls: roles = auth_service.get_user_roles(phone)
    â†“ determines: other_role = 'client' if role == 'trainer' else 'trainer'
    â†“ checks: has_other_role = bool(roles[other_role])
    â†“ builds: final_warning = "âš ï¸ FINAL CONFIRMATION\n\nThis is your last chance!"
    â†“ if role == 'trainer':
    â†“   adds: "Permanently remove trainer data, habits, assignments"
    â†“ else:
    â†“   adds: "Permanently remove client data, habit logs"
    â†“ if has_other_role:
    â†“   adds: "Your {other_role} account will remain active"
    â†“ else:
    â†“   adds: "Your entire account will be deleted"
    â†“ adds: "THIS CANNOT BE UNDONE!"
    â†“ builds: buttons = [
    â†“   {"id": f"final_confirm_delete_{role}_{user_id}", "title": "âš ï¸ DELETE NOW"},
    â†“   {"id": "final_cancel_delete", "title": "âŒ Cancel"}
    â†“ ]
    â†“ calls: whatsapp.send_button_message(phone, final_warning, buttons)
    â†“ [Sends second confirmation with final warning]

[User clicks "âš ï¸ DELETE NOW" button]
12. routes/webhooks.py â†’ whatsapp_webhook()
    â†“ interactive_type="button_reply", button_reply.id="final_confirm_delete_trainer_TR_ASRA_111"

13. services/message_router/message_router.py â†’ route_message()
    â†“ STEP 0: button_id = "final_confirm_delete_trainer_TR_ASRA_111" â†’ SKIP TO button_handler

14. services/message_router/handlers/buttons/button_handler.py â†’ handle_button_response()
    â†“ checks: if button_id.startswith('final_confirm_delete_') or button_id == 'final_cancel_delete'
    â†“ calls: _handle_final_delete_confirmation(phone, button_id)

15. services/message_router/handlers/buttons/button_handler.py â†’ _handle_final_delete_confirmation()
    â†“ checks: if button_id == 'final_cancel_delete'
    â†“   sends: "Account Deletion Cancelled" message
    â†“   returns: success
    â†“ extracts: parts = button_id.replace('final_confirm_delete_', '').split('_', 1)
    â†“ gets: role, user_id = parts = ['trainer', 'TR_ASRA_111']
    â†“ validates: login_status = auth_service.get_login_status(phone) == role
    â†“ validates: current_user_id = auth_service.get_user_id_by_role(phone, role) == user_id
    â†“ creates: user_manager = UserManager(db)
    â†“ calls: success = user_manager.delete_user_role(phone, role)

16. services/auth/core/user_manager.py â†’ delete_user_role()
    â†“ cleans: clean_phone = phone.replace('+', '').replace('-', '').replace(' ', '')
    â†“ calls: user = self.check_user_exists(clean_phone)
    â†“ gets: role_id = user.get(f'{role}_id') = 'TR_ASRA_111'
    â†“ calls: self._delete_role_related_data(role_id, role, clean_phone)

17. services/auth/core/user_manager.py â†’ _delete_role_related_data()
    â†“ if role == 'client':
    â†“   deletes: db.table('client_trainer_list').delete().eq('client_id', role_id)
    â†“   deletes: db.table('trainer_client_list').delete().eq('client_id', role_id)
    â†“   deletes: db.table('client_tasks').delete().eq('client_id', role_id)
    â†“   deletes: db.table('client_invitations').delete().eq('client_phone', phone)
    â†“   deletes: db.table('client_habits').delete().eq('client_id', role_id)
    â†“   deletes: db.table('habit_logs').delete().eq('client_id', role_id)
    â†“ elif role == 'trainer':
    â†“   deletes: db.table('trainer_client_list').delete().eq('trainer_id', role_id)
    â†“   deletes: db.table('client_trainer_list').delete().eq('trainer_id', role_id)
    â†“   deletes: db.table('trainer_tasks').delete().eq('trainer_id', role_id)
    â†“   deletes: db.table('client_invitations').delete().eq('trainer_id', role_id)
    â†“   deletes: db.table('trainer_habits').delete().eq('trainer_id', role_id)

18. Back to delete_user_role()
    â†“ determines: table = 'trainers' if role == 'trainer' else 'clients'
    â†“ determines: id_column = 'trainer_id' if role == 'trainer' else 'client_id'
    â†“ deletes: db.table(table).delete().eq(id_column, role_id).execute()
    â†“ determines: other_role = 'client' if role == 'trainer' else 'trainer'
    â†“ gets: other_role_id = user.get(f'{other_role}_id')
    â†“ if other_role_id:
    â†“   updates: db.table('users').update({
    â†“     f'{role}_id': None,
    â†“     'updated_at': NOW()
    â†“   }).eq('phone_number', clean_phone)
    â†“ else:
    â†“   deletes: db.table('users').delete().eq('phone_number', clean_phone).execute()
    â†“ returns: True

19. Back to _handle_final_delete_confirmation()
    â†“ if success:
    â†“   calls: roles = auth_service.get_user_roles(phone)
    â†“   determines: other_role = 'client' if role == 'trainer' else 'trainer'
    â†“   if roles[other_role]:
    â†“     builds: msg = "{role} Account Deleted\nYour {other_role} account is still active"
    â†“   else:
    â†“     builds: msg = "Account Deleted\nThank you for using Refiloe"
    â†“   calls: whatsapp.send_message(phone, msg)
    â†“   [Sends success confirmation message]
    â†“ else:
    â†“   builds: msg = "Deletion Failed\nYour account is still active"
    â†“   calls: whatsapp.send_message(phone, msg)
```

## Key Context Points

**Message Types:**

- `text` â†’ Command message (e.g., "/delete-account")
- `interactive.button_reply` â†’ Button click (button_id: "/delete-account", "confirm_delete_trainer", "final_confirm_delete_trainer_TR_ASRA_111")

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` â†’ Prevents duplicate webhooks
- `users (dev_note\current_schemas\users.sql)` â†’ Gets login_status, trainer_id/client_id, updated or deleted
- `trainers (dev_note\current_schemas\trainers.sql)` â†’ Trainer profile data (deleted by trainer_id)
- `clients (dev_note\current_schemas\clients.sql)` â†’ Client profile data (deleted by client_id)
- `trainer_client_list (dev_note\current_schemas\trainer_client_list.sql)` â†’ Trainer-client relationships (deleted)
- `client_trainer_list (dev_note\current_schemas\client_trainer_list.sql)` â†’ Client-trainer relationships (deleted)
- `trainer_tasks (dev_note\current_schemas\trainer_tasks.sql)` â†’ Trainer tasks (deleted)
- `client_tasks (dev_note\current_schemas\client_tasks.sql)` â†’ Client tasks (deleted)
- `client_invitations (dev_note\current_schemas\client_invitations.sql)` â†’ Invitations (deleted)
- `trainer_habits (dev_note\current_schemas\trainer_habits.sql)` â†’ Trainer habits (deleted)
- `client_habits (dev_note\current_schemas\client_habits.sql)` â†’ Client habits (deleted)
- `habit_logs (dev_note\current_schemas\habit_logs.sql)` â†’ Habit logs (deleted for clients)

**Button Flow (Double Confirmation):**

1. **First Confirmation:**

   - Button ID: `confirm_delete_{role}` (e.g., "confirm_delete_trainer")
   - Shows: Role-specific consequences, other role status
   - Options: "âœ… Confirm Delete" or "âŒ Cancel"

2. **Second Confirmation (Final):**

   - Button ID: `final_confirm_delete_{role}_{user_id}` (e.g., "final_confirm_delete_trainer_TR_ASRA_111")
   - Shows: "FINAL CONFIRMATION", "THIS CANNOT BE UNDONE!"
   - Options: "âš ï¸ DELETE NOW" or "âŒ Cancel"

**Key Functions:**

- `handle_delete_account()` â†’ Sends first confirmation with buttons
- `_handle_delete_account_button()` â†’ Validates session, sends second confirmation
- `_handle_final_delete_confirmation()` â†’ Validates user_id, executes deletion
- `UserManager.delete_user_role()` â†’ Main deletion orchestrator
- `UserManager._delete_role_related_data()` â†’ Deletes all related data

**Known Limitations:**

1. **No undo:** Once deleted, data cannot be recovered
2. **Immediate effect:** Deletion happens instantly after final confirmation
3. **No backup:** No automatic backup is created before deletion
4. **Relationship cleanup:** All relationships are permanently removed
5. **Habit data:** Trainer habits and client logs are permanently deleted

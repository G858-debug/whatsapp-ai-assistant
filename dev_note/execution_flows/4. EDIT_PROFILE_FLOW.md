# Edit Profile Flow

## Complete Flow Path

```
[User sends "/edit-profile" command or clicks "✏️ Edit Profile" button]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="/edit-profile" OR interactive.button_reply.id="/edit-profile"
2. services/message_router/message_router.py (route_message)
   ↓ user exists, logged in as 'trainer' or 'client'
   ↓ detects command starts with '/' OR button_id detected
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user OR handle_logged_in_button)
   ↓ routes to role_command_handler
4. services/message_router/handlers/commands/role_command_handler.py (handle_role_command)
   ↓ checks common commands first
5. services/message_router/handlers/commands/common_commands.py (handle_common_command)
   ↓ cmd == '/edit-profile'
6. services/message_router/handlers/commands/common_commands.py (_handle_edit_profile)
   ↓ calls handle_edit_profile from services.commands
7. services/commands/common/profile_commands.py (handle_edit_profile)
   ↓ creates ProfileEditor instance
8. services/profile_editor/profile_editor.py (send_edit_flow)
   ↓ queries trainers/clients table for current profile data
   ↓ deletes any old active edit flow tokens
   ↓ generates flow_token="edit_profile_{role}_{phone}_{timestamp}"
   ↓ [Sends current profile summary message]
   ↓ [Sends WhatsApp Flow form (empty, not pre-filled)]
   ↓ saves flow_token to flow_tokens table with user_id

[User fills form with fields they want to change and submits]
9. routes/webhooks.py (whatsapp_webhook)
   ↓ interactive_type="nfm_reply" (WhatsApp Flow response)
10. flow_handlers/flow_response_handler.py (process_flow_webhook)
    ↓ extracts flow_data, detects "edit_profile_trainer" or "edit_profile_client" in flow_token
11. services/profile_editor/profile_editor.py (process_edit_completion)
    ↓ gets user_id from flow_tokens table using flow_token
    ↓ queries trainers/clients table for current profile data
    ↓ compares submitted data with current data
    ↓ builds update_data dict with only changed fields
    ↓ validates updates (email uniqueness, pricing format, at least one field)
    ↓ updates trainers/clients table (only changed fields)
    ↓ marks flow_token status='completed'
    ↓ [Sends confirmation message with changes summary]
```

## Key Context Points

**Message Types:**

- `text` → Command message (e.g., "/edit-profile")
- `interactive.button_reply` → Button click (button_id: "/edit-profile")
- `interactive.nfm_reply` → WhatsApp Flow submission (contains flow_token + form data)

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` → Prevents duplicate webhooks
- `users (dev_note\current_schemas\users.sql)` → Gets login_status, trainer_id/client_id
- `trainers (dev_note\current_schemas\trainers.sql)` → Trainer profile data (queried and updated by trainer_id)
- `clients (dev_note\current_schemas\clients.sql)` → Client profile data (queried and updated by client_id)
- `flow_tokens (dev_note\current_schemas\flow_tokens.sql)` → Tracks edit flow sessions with user_id

**Key Functions:**

- `ProfileEditor.send_edit_flow()` → Queries profile, sends summary + flow, saves token
- `ProfileEditor._get_current_profile()` → Queries trainers/clients table by user_id
- `ProfileEditor._format_profile_summary()` → Formats current data as message
- `ProfileEditor._save_flow_token()` → Saves token with user_id to flow_tokens table
- `ProfileEditor.process_edit_completion()` → Processes flow submission
- `ProfileEditor._get_flow_token_record()` → Retrieves token record with user_id
- `ProfileEditor._build_update_data()` → Compares old vs new, extracts changes
- `ProfileEditor._validate_updates()` → Validates email uniqueness, pricing, required fields
- `ProfileEditor._save_profile_updates()` → Updates database with changed fields only
- `ProfileEditor._build_changes_summary()` → Creates human-readable summary
- `ProfileEditor._mark_flow_completed()` → Updates flow_token status

**Known Limitations:**

1. **No pre-filling:** WhatsApp API doesn't support pre-filling form data
2. **Re-entry required:** Users must re-enter data even for small changes
3. **Phone number:** Cannot be changed (it's the primary identifier)
4. **Profile pictures:** Not supported in WhatsApp Flows
5. **Undo:** No undo functionality after submission
6. **Constraint requirement:** Database constraint must be manually updated to allow edit flow types

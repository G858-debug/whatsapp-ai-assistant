# Edit Profile Flow (Trainer & Client)

## Overview

The Edit Profile flow reuses the WhatsApp Flow onboarding forms (trainer_onboarding_flow, client_onboarding_flow) but operates in "edit mode" to update existing user data. It pre-fills the form with current profile data and saves updates without creating new user entries.

## Complete Flow Path

```
[User sends "/edit-profile" command]
1. routes/webhooks.py (whatsapp_webhook)
   ↓ text="/edit-profile"
2. services/message_router/message_router.py (route_message)
   ↓ user exists, logged in as 'trainer' or 'client'
3. services/message_router/handlers/logged_in_user_handler.py (handle_logged_in_user)
   ↓ detects command starts with '/'
4. services/message_router/handlers/commands/role_command_handler.py (handle_role_command)
   ↓ checks common commands first
5. services/message_router/handlers/commands/common_commands.py (handle_common_command)
   ↓ cmd == '/edit-profile'
6. services/commands/common/profile_commands.py (handle_edit_profile)
   ↓ creates ProfileEditor instance
7. services/profile_editor/profile_editor.py (send_edit_flow)
   ↓ queries database for current profile data
   ↓ generates flow_token with "edit_profile_{role}_{phone}_{timestamp}"
   ↓ [Sends WhatsApp Flow with pre-filled data]

[User modifies form and submits]
8. routes/webhooks.py (whatsapp_webhook)
   ↓ interactive_type="nfm_reply" (WhatsApp Flow response)
9. flow_handlers/flow_response_handler.py (process_flow_webhook)
   ↓ extracts flow_data, detects "edit_profile" in flow_token
10. services/profile_editor/profile_editor.py (process_edit_completion)
    ↓ validates data, builds update_data
11. services/profile_editor/profile_editor.py (save_profile_updates)
    ↓ updates trainers/clients table (NO new user creation)
    ↓ [Sends confirmation message with changes summary]
```

## Key Differences from Registration Flow

**Registration Flow:**

- Creates new trainer/client record
- Creates new user entry in users table
- Generates new trainer_id/client_id
- Auto-login after completion
- flow*token: `trainer_onboarding*{phone}\_{timestamp}`

**Edit Profile Flow:**

- Updates existing trainer/client record
- NO changes to users table
- Uses existing trainer_id/client_id
- User already logged in
- flow*token: `edit_profile_trainer*{phone}_{timestamp}`or`edit_profile_client_{phone}\_{timestamp}`

## Implementation Strategy

### Phase 1: Create Profile Editor Service

**File:** `services/profile_editor/profile_editor.py`

**Key Methods:**

```python
class ProfileEditor:
    def __init__(self, supabase, whatsapp_service):
        # Initialize with same flow_ids as registration
        self.trainer_flow_id = os.getenv('TRAINER_ONBOARDING_FLOW_ID')
        self.client_flow_id = os.getenv('CLIENT_ONBOARDING_FLOW_ID')

    def send_edit_flow(self, phone: str, role: str, user_id: str) -> Dict:
        """
        Send WhatsApp Flow pre-filled with current profile data

        Args:
            phone: User's WhatsApp number
            role: 'trainer' or 'client'
            user_id: trainer_id or client_id

        Returns:
            Dict with success status, flow_token
        """
        # 1. Query current profile data
        current_data = self._get_current_profile(role, user_id)

        # 2. Generate edit flow token
        flow_token = f"edit_profile_{role}_{phone}_{timestamp}"

        # 3. Build flow message with screen_data (pre-filled values)
        flow_message = {
            "messaging_product": "whatsapp",
            "to": phone,
            "type": "interactive",
            "interactive": {
                "type": "flow",
                "header": {"type": "text", "text": "✏️ Edit Profile"},
                "body": {"text": "Update your profile information below."},
                "action": {
                    "name": "flow",
                    "parameters": {
                        "flow_message_version": "3",
                        "flow_token": flow_token,
                        "flow_id": self.trainer_flow_id if role == 'trainer' else self.client_flow_id,
                        "flow_cta": "Update Profile",
                        "flow_action": "data_exchange",
                        "mode": "draft",  # Important: allows pre-filling
                        "screen_data": current_data  # Pre-filled values
                    }
                }
            }
        }

        # 4. Send flow and save token
        result = self.whatsapp.send_flow_message(flow_message)
        self._save_flow_token(phone, flow_token, role, user_id)

        return result

    def _get_current_profile(self, role: str, user_id: str) -> Dict:
        """
        Query database and format data for flow pre-filling

        Returns:
            Dict matching flow field names with current values
        """
        table = 'trainers' if role == 'trainer' else 'clients'
        id_column = 'trainer_id' if role == 'trainer' else 'client_id'

        result = self.db.table(table).select('*').eq(id_column, user_id).execute()

        if not result.data:
            return {}

        data = result.data[0]

        # Map database columns to flow field names
        if role == 'trainer':
            return {
                'first_name': data.get('first_name', ''),
                'surname': data.get('last_name', ''),
                'email': data.get('email', ''),
                'city': data.get('city', ''),
                'sex': data.get('sex', ''),
                'birthdate': data.get('birthdate', ''),
                'business_name': data.get('business_name', ''),
                'specializations': data.get('specializations_arr', []),
                'experience_years': data.get('experience_years', ''),
                'pricing_per_session': str(data.get('pricing_per_session', '')),
                'services_offered': data.get('services_offered', []),
                'subscription_plan': data.get('subscription_status', 'basic'),
                # Working hours - extract from JSONB
                **self._extract_working_hours_for_flow(data.get('working_hours', {}))
            }
        else:  # client
            return {
                'full_name': data.get('name', ''),
                'email': data.get('email', ''),
                'phone_number': data.get('whatsapp', ''),
                'fitness_goals': data.get('fitness_goals', []),
                'experience_level': data.get('experience_level', ''),
                'health_conditions': data.get('health_conditions', ''),
                'availability': data.get('availability', []),
                'preferred_training_type': data.get('preferred_training_times', [])
            }

    def _extract_working_hours_for_flow(self, working_hours: Dict) -> Dict:
        """
        Convert working_hours JSONB to flow field format

        Args:
            working_hours: {
                "monday": {"preset": "business", "hours": []},
                "tuesday": {"preset": "morning", "hours": []},
                ...
            }

        Returns:
            {
                "monday_preset": "business",
                "monday_hours": [],
                "tuesday_preset": "morning",
                ...
            }
        """
        flow_fields = {}
        days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']

        for day in days:
            day_data = working_hours.get(day, {})
            flow_fields[f"{day}_preset"] = day_data.get('preset', 'not_available')
            flow_fields[f"{day}_hours"] = day_data.get('hours', [])

        return flow_fields

    def process_edit_completion(self, flow_data: Dict, phone_number: str) -> Dict:
        """
        Process completed edit flow and update profile

        Args:
            flow_data: Data submitted from WhatsApp Flow
            phone_number: User's WhatsApp number

        Returns:
            Dict with success status, changes summary
        """
        # 1. Extract flow_token and determine role
        flow_token = flow_data.get('flow_token', '')

        if 'edit_profile_trainer' in flow_token:
            role = 'trainer'
        elif 'edit_profile_client' in flow_token:
            role = 'client'
        else:
            return {'success': False, 'error': 'Invalid flow token'}

        # 2. Get user_id from flow_tokens table
        token_record = self._get_flow_token_record(flow_token)
        if not token_record:
            return {'success': False, 'error': 'Flow token not found'}

        user_id = token_record.get('user_id')  # trainer_id or client_id

        # 3. Get current profile for comparison
        current_data = self._get_current_profile(role, user_id)

        # 4. Build update data (only changed fields)
        update_data = self._build_update_data(flow_data, current_data, role)

        # 5. Validate updates
        validation_errors = self._validate_updates(update_data, role)
        if validation_errors:
            return {'success': False, 'error': validation_errors}

        # 6. Save updates to database
        success, message = self._save_profile_updates(role, user_id, update_data)

        if success:
            # 7. Build changes summary
            changes_summary = self._build_changes_summary(current_data, update_data, role)

            # 8. Send confirmation message
            confirmation_msg = (
                f"✅ *Profile Updated Successfully!*\n\n"
                f"{changes_summary}\n\n"
                f"Type /view-profile to see your updated profile."
            )
            self.whatsapp.send_message(phone_number, confirmation_msg)

            # 9. Mark flow token as completed
            self._mark_flow_completed(flow_token)

            return {'success': True, 'message': message, 'changes': changes_summary}
        else:
            return {'success': False, 'error': message}

    def _build_update_data(self, flow_data: Dict, current_data: Dict, role: str) -> Dict:
        """
        Build update data dict with only changed fields

        Args:
            flow_data: New data from flow submission
            current_data: Current profile data
            role: 'trainer' or 'client'

        Returns:
            Dict with only changed fields mapped to database columns
        """
        updates = {}

        if role == 'trainer':
            # Map flow fields to database columns
            field_mapping = {
                'first_name': 'first_name',
                'surname': 'last_name',
                'email': 'email',
                'city': 'city',
                'sex': 'sex',
                'birthdate': 'birthdate',
                'business_name': 'business_name',
                'specializations': 'specializations_arr',
                'experience_years': 'experience_years',
                'pricing_per_session': 'pricing_per_session',
                'services_offered': 'services_offered',
                'subscription_plan': 'subscription_status'
            }

            for flow_field, db_column in field_mapping.items():
                new_value = flow_data.get(flow_field)
                current_value = current_data.get(flow_field)

                # Only include if changed
                if new_value != current_value:
                    updates[db_column] = new_value

            # Handle working_hours separately (complex JSONB)
            new_working_hours = self._build_working_hours_from_flow(flow_data)
            current_working_hours = self._extract_working_hours_for_flow(
                current_data.get('working_hours', {})
            )

            if new_working_hours != current_working_hours:
                updates['working_hours'] = new_working_hours
                # Also update derived fields
                updates['available_days'] = self._extract_available_days(new_working_hours)
                updates['preferred_time_slots'] = self._extract_preferred_time_slots(new_working_hours)

        else:  # client
            field_mapping = {
                'full_name': 'name',
                'email': 'email',
                'fitness_goals': 'fitness_goals',
                'experience_level': 'experience_level',
                'health_conditions': 'health_conditions',
                'availability': 'availability',
                'preferred_training_type': 'preferred_training_times'
            }

            for flow_field, db_column in field_mapping.items():
                new_value = flow_data.get(flow_field)
                current_value = current_data.get(flow_field)

                if new_value != current_value:
                    updates[db_column] = new_value

        # Always update updated_at timestamp
        if updates:
            updates['updated_at'] = datetime.now(self.sa_tz).isoformat()

        return updates

    def _save_profile_updates(self, role: str, user_id: str, update_data: Dict) -> Tuple[bool, str]:
        """
        Save profile updates to database

        Args:
            role: 'trainer' or 'client'
            user_id: trainer_id or client_id
            update_data: Dict with fields to update

        Returns:
            (success, message)
        """
        try:
            if not update_data:
                return True, "No changes detected"

            table = 'trainers' if role == 'trainer' else 'clients'
            id_column = 'trainer_id' if role == 'trainer' else 'client_id'

            # Update database
            result = self.db.table(table).update(update_data).eq(id_column, user_id).execute()

            if result.data:
                log_info(f"Profile updated for {role} {user_id}: {len(update_data)} fields")
                return True, f"Updated {len(update_data)} fields"
            else:
                return False, "Failed to update profile"

        except Exception as e:
            log_error(f"Error saving profile updates: {str(e)}")
            return False, str(e)

    def _build_changes_summary(self, old_data: Dict, new_data: Dict, role: str) -> str:
        """
        Build human-readable summary of changes

        Returns:
            Formatted string with changes
        """
        if not new_data:
            return "No changes were made."

        summary = "*Changes Made:*\n"

        # Map database columns to friendly labels
        if role == 'trainer':
            labels = {
                'first_name': 'First Name',
                'last_name': 'Last Name',
                'email': 'Email',
                'city': 'City',
                'business_name': 'Business Name',
                'specializations_arr': 'Specializations',
                'experience_years': 'Experience',
                'pricing_per_session': 'Price per Session',
                'services_offered': 'Services Offered',
                'working_hours': 'Availability Schedule'
            }
        else:
            labels = {
                'name': 'Name',
                'email': 'Email',
                'fitness_goals': 'Fitness Goals',
                'experience_level': 'Experience Level',
                'health_conditions': 'Health Conditions',
                'availability': 'Availability',
                'preferred_training_times': 'Preferred Training'
            }

        for field, new_value in new_data.items():
            if field in ['updated_at', 'available_days', 'preferred_time_slots']:
                continue  # Skip meta fields

            label = labels.get(field, field)

            # Format value
            if isinstance(new_value, list):
                formatted_value = ', '.join(str(v) for v in new_value)
            elif isinstance(new_value, dict):
                formatted_value = "Updated"
            else:
                formatted_value = str(new_value)

            summary += f"• {label}: {formatted_value}\n"

        return summary
```

### Phase 2: Update Flow Response Handler

**File:** `flow_handlers/flow_response_handler.py`

Add detection for edit_profile flow tokens:

```python
def process_flow_webhook(webhook_data: Dict, db, whatsapp) -> Dict:
    """Process WhatsApp Flow webhook responses"""

    # ... existing code ...

    # Detect flow type from flow_token
    if 'trainer_onboarding' in flow_token:
        # Existing registration flow
        from services.flows.registration.whatsapp_flow_trainer_onboarding import WhatsAppFlowTrainerOnboarding
        handler = WhatsAppFlowTrainerOnboarding(db, whatsapp)
        return handler.process_flow_completion(flow_data, phone_number)

    elif 'edit_profile_trainer' in flow_token or 'edit_profile_client' in flow_token:
        # NEW: Edit profile flow
        from services.profile_editor.profile_editor import ProfileEditor
        editor = ProfileEditor(db, whatsapp)
        return editor.process_edit_completion(flow_data, phone_number)

    # ... rest of code ...
```

### Phase 3: Update Profile Commands

**File:** `services/commands/common/profile_commands.py`

Replace current `handle_edit_profile` implementation:

```python
def handle_edit_profile(phone: str, role: str, user_id: str, db, whatsapp, reg_service) -> Dict:
    """Handle edit profile command - sends WhatsApp Flow with pre-filled data"""
    try:
        from services.profile_editor import ProfileEditor

        editor = ProfileEditor(db, whatsapp)
        result = editor.send_edit_flow(phone, role, user_id)

        if result.get('success'):
            return {
                'success': True,
                'response': "Opening your profile editor...",
                'handler': 'edit_profile_flow_sent'
            }
        else:
            return {
                'success': False,
                'response': "Sorry, I couldn't open the profile editor.",
                'handler': 'edit_profile_flow_error'
            }

    except Exception as e:
        log_error(f"Error starting profile edit: {str(e)}")
        return {
            'success': False,
            'response': "Sorry, I couldn't start profile editing.",
            'handler': 'edit_profile_error'
        }
```

## Database Schema Updates

### flow_tokens Table

Add `user_id` column to track which user is editing:

```sql
ALTER TABLE flow_tokens
ADD COLUMN user_id TEXT;  -- stores trainer_id or client_id

-- Update existing flow_token saves to include user_id
```

**Updated flow_tokens structure:**

```
flow_tokens:
  - flow_token (PK)
  - phone_number
  - flow_type ('trainer_onboarding', 'client_onboarding', 'edit_profile_trainer', 'edit_profile_client')
  - user_id (NEW: trainer_id or client_id for edit flows)
  - status ('active', 'completed', 'failed', 'abandoned')
  - created_at
  - completed_at
  - error
```

## Key Context Points

**Flow Token Patterns:**

- Registration: `trainer_onboarding_{phone}_{timestamp}`
- Edit Trainer: `edit_profile_trainer_{phone}_{timestamp}`
- Edit Client: `edit_profile_client_{phone}_{timestamp}`

**Flow IDs (Same as Registration):**

- Trainer: `TRAINER_ONBOARDING_FLOW_ID` from .env
- Client: `CLIENT_ONBOARDING_FLOW_ID` from .env

**Pre-filling Data:**

- Use `mode: "draft"` in flow parameters
- Include `screen_data` with current values
- Field names must match flow JSON schema exactly

**Data Handling:**

- Query current data before sending flow
- Compare old vs new data to detect changes
- Only update changed fields (efficiency)
- NO changes to users table (user already exists)
- NO new ID generation (use existing trainer_id/client_id)

**Validation:**

- Same validation rules as registration
- Check for duplicate email (excluding current user)
- Validate required fields
- Validate data types and formats

**Error Handling:**

- Flow token not found → "Session expired, please try again"
- Validation errors → Show specific errors, don't save
- Database errors → Log and show generic error
- Mark flow_token as 'failed' on errors

**User Experience:**

- Pre-filled form shows current values
- User only changes what they want
- Confirmation shows summary of changes
- Can view updated profile immediately

## Testing Checklist

- [ ] Trainer can edit profile via /edit-profile
- [ ] Client can edit profile via /edit-profile
- [ ] Form pre-fills with current data correctly
- [ ] Only changed fields are updated in database
- [ ] Working hours JSONB updates correctly
- [ ] Array fields (specializations, services) update correctly
- [ ] Email uniqueness validation (excluding current user)
- [ ] Changes summary shows accurate information
- [ ] Flow token marked as completed after success
- [ ] Old flow tokens cleaned up
- [ ] Error handling for invalid flow tokens
- [ ] Error handling for database failures
- [ ] users table NOT modified during edit
- [ ] trainer_id/client_id remains unchanged

## Migration Notes

**Backward Compatibility:**

- Existing registration flows continue to work
- Same flow IDs used for both registration and editing
- flow_tokens table extended (not replaced)
- No changes to existing trainers/clients data

**Deployment Steps:**

1. Add `user_id` column to flow_tokens table
2. Deploy ProfileEditor service
3. Update flow_response_handler.py
4. Update profile_commands.py
5. Test with existing users
6. Monitor flow_tokens for proper tracking

## Future Enhancements

**Selective Field Editing:**

- Allow editing specific sections only
- "Edit Basic Info", "Edit Availability", etc.
- Reduces form complexity for small changes

**Change History:**

- Track profile changes over time
- Show "Last updated: X days ago"
- Audit trail for compliance

**Validation Improvements:**

- Real-time validation in flow
- Check email availability before submission
- Suggest corrections for invalid data

**Bulk Updates:**

- Admin can update multiple trainers
- Import/export profile data
- Batch operations for data migration

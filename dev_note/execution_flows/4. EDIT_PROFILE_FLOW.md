# Edit Profile Flow

## Complete Flow Path

```
[User sends "/edit-profile" command or clicks "✏️ Edit Profile" button]
1. routes/webhooks.py → whatsapp_webhook()
   ↓ text="/edit-profile" OR interactive.button_reply.id="/edit-profile"

2. services/message_router/message_router.py → route_message()
   ↓
   ↓ STEP 0: Check if button_id exists
   ↓ ├─ FOR /edit-profile command: button_id = None → Continue to STEP 0.1
   ↓ └─ FOR button click: button_id = "/edit-profile" → SKIP TO STEP 3.
   ↓
   ↓ STEP 3: Check if user exists
   ↓ ├─ FOR /edit-profile: user = user_manager.check_user_exists(phone)
   ↓ ├─ FOR logged-in user: user exists
   ↓ └─ RESULT: Continue to STEP 4
   ↓
   ↓ STEP 4: Check login status
   ↓ ├─ FOR /edit-profile: login_status = user.get('login_status')
   ↓ ├─ FOR logged-in user: login_status = 'trainer' or 'client'
   ↓ └─ RESULT: Continue to STEP 5
   ↓
   ↓ STEP 5: User is logged in
   ↓ calls: button_handler.handle_logged_in_message(phone, "/edit-profile", login_status)

3. services/message_router/handlers/logged_in_user_handler.py → handle_logged_in_user()
   ↓ checks: if message.startswith('/') = True
   ↓ gets: user_id = auth_service.get_user_id_by_role(phone, role)
   ↓ calls: role_command_handler.handle_role_command(phone, "/edit-profile", role, user_id)

4. services/message_router/handlers/commands/role_command_handler.py → handle_role_command()
   ↓ cmd = command.lower().strip() = "/edit-profile"
   ↓ calls: common_handler.handle_common_command(phone, cmd, role, user_id)

5. services/message_router/handlers/commands/common_commands.py → handle_common_command()
   ↓ checks: if cmd == '/edit-profile' = True
   ↓ calls: _handle_edit_profile(phone, role, user_id)

6. services/message_router/handlers/commands/common_commands.py → _handle_edit_profile()
   ↓ imports: from services.commands import handle_edit_profile
   ↓ calls: handle_edit_profile(phone, role, user_id, db, whatsapp, reg_service)

7. services/commands/common/profile_commands.py → handle_edit_profile()
   ↓ imports: from services.profile_editor import ProfileEditor
   ↓ creates: editor = ProfileEditor(db, whatsapp)
   ↓ calls: editor.send_edit_flow(phone, role, user_id)

8. services/profile_editor/profile_editor.py → send_edit_flow()
   ↓ calls: current_data = self._get_current_profile(role, user_id)
   ↓ queries: db.table(table).select('*').eq(id_column, user_id).execute()
   ↓ calls: self._mark_abandoned_flows(phone, role)
   ↓ deletes: db.table('flow_tokens').delete().eq('phone_number', phone).eq('flow_type', f'edit_profile_{role}').neq('status', 'completed')
   ↓ generates: flow_token = f"edit_profile_{role}_{phone}_{timestamp}"
   ↓ calls: summary = self._format_profile_summary(current_data, role)
   ↓ calls: whatsapp.send_message(phone, summary)
   ↓ [Sends current profile summary message]
   ↓ builds: flow_message with flow_id, flow_token, flow_cta="Update Profile"
   ↓ calls: whatsapp.send_flow_message(flow_message)
   ↓ [Sends WhatsApp Flow form (empty, not pre-filled due to WhatsApp limitation)]
   ↓ calls: self._save_flow_token(phone, flow_token, role, user_id)
   ↓ inserts: db.table('flow_tokens').insert({flow_token, phone_number, flow_type, user_id, status='active'})

[User fills form with fields they want to change and submits]
9. routes/webhooks.py → whatsapp_webhook()
   ↓ interactive_type="nfm_reply" (WhatsApp Flow response)
   ↓ extracts: flow_data = json.loads(nfm_reply['response_json'])

10. flow_handlers/flow_response_handler.py → process_flow_webhook()
    ↓ extracts: flow_token = flow_data.get('flow_token')
    ↓ checks: if 'edit_profile_trainer' in flow_token or 'edit_profile_client' in flow_token
    ↓ imports: from services.profile_editor import ProfileEditor
    ↓ creates: profile_editor = ProfileEditor(supabase, whatsapp_service)
    ↓ calls: profile_editor.process_edit_completion(flow_data, phone_number)

11. services/profile_editor/profile_editor.py → process_edit_completion()
    ↓ extracts: flow_token = flow_data.get('flow_token')
    ↓ determines: role = 'trainer' if 'edit_profile_trainer' in flow_token else 'client'
    ↓ calls: token_record = self._get_flow_token_record(flow_token)
    ↓ queries: db.table('flow_tokens').select('*').eq('flow_token', flow_token).execute()
    ↓ gets: user_id = token_record.get('user_id')
    ↓ calls: current_data = self._get_current_profile(role, user_id)
    ↓ queries: db.table(table).select('*').eq(id_column, user_id).execute()
    ↓ calls: update_data = self._build_update_data(flow_data, current_data, role)
    ↓ compares: new_value != current_value for each field
    ↓ builds: updates dict with only changed fields
    ↓ calls: validation_errors = self._validate_updates(flow_data, role, user_id)
    ↓ checks: email uniqueness, pricing format, at least one field provided
    ↓ if no changes: sends "No Changes Detected" message, marks flow completed
    ↓ calls: success, message = self._save_profile_updates(role, user_id, update_data)
    ↓ updates: db.table(table).update(update_data).eq(id_column, user_id).execute()
    ↓ calls: changes_summary = self._build_changes_summary(update_data, role)
    ↓ builds: confirmation message with changes list
    ↓ calls: whatsapp.send_message(phone_number, confirmation_msg)
    ↓ calls: self._mark_flow_completed(flow_token)
    ↓ updates: db.table('flow_tokens').update({status='completed', completed_at=NOW()}).eq('flow_token', flow_token)
    ↓ [Sends confirmation message with changes summary]
```

## Key Context Points

**Message Types:**

- `text` → Command message (e.g., "/edit-profile")
- `interactive.button_reply` → Button click (button_id: "/edit-profile")
- `interactive.nfm_reply` → WhatsApp Flow submission (contains flow_token + form data)

**Database Tables:**

- `processed_messages (dev_note\current_schemas\processed_messages.sql)` → Prevents duplicate webhooks
- `users (dev_note\current_schemas\users.sql)` → Gets login_status, trainer_id/client_id
- `trainers (dev_note\current_schemas\trainers.sql)` → Trainer profile data (queried and updated by trainer_id)
- `clients (dev_note\current_schemas\clients.sql)` → Client profile data (queried and updated by client_id)
- `flow_tokens (dev_note\current_schemas\flow_tokens.sql)` → Tracks edit flow sessions with user_id

**Key Functions:**

- `ProfileEditor.send_edit_flow()` → Queries profile, sends summary + flow, saves token
- `ProfileEditor._get_current_profile()` → Queries trainers/clients table by user_id
- `ProfileEditor._format_profile_summary()` → Formats current data as message
- `ProfileEditor._save_flow_token()` → Saves token with user_id to flow_tokens table
- `ProfileEditor.process_edit_completion()` → Processes flow submission
- `ProfileEditor._get_flow_token_record()` → Retrieves token record with user_id
- `ProfileEditor._build_update_data()` → Compares old vs new, extracts changes
- `ProfileEditor._validate_updates()` → Validates email uniqueness, pricing, required fields
- `ProfileEditor._save_profile_updates()` → Updates database with changed fields only
- `ProfileEditor._build_changes_summary()` → Creates human-readable summary
- `ProfileEditor._mark_flow_completed()` → Updates flow_token status

**Known Limitations:**

1. **No pre-filling:** WhatsApp API doesn't support pre-filling form data
2. **Re-entry required:** Users must re-enter data even for small changes
3. **Phone number:** Cannot be changed (it's the primary identifier)
4. **Profile pictures:** Not supported in WhatsApp Flows
5. **Undo:** No undo functionality after submission
6. **Constraint requirement:** Database constraint must be manually updated to allow edit flow types

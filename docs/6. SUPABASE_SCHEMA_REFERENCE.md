# ðŸ“Š Supabase Schema Reference

## Overview

This document provides the database schema for trainer-related tables. Use this as a reference when making code changes.

---

## 1. `trainers` Table

```sql
CREATE TABLE public.trainers (
  -- Primary Key (UUID)
  id uuid NOT NULL DEFAULT gen_random_uuid(),

  -- Secondary ID (VARCHAR) - Used for display and some queries
  trainer_id character varying(10) NULL,

  -- Contact Information
  whatsapp character varying(20) NOT NULL,  -- UNIQUE
  email character varying(255) NOT NULL,     -- UNIQUE

  -- Personal Information
  name character varying(200) NOT NULL,
  first_name character varying(255) NULL,
  last_name character varying(255) NULL,

  -- Business Information
  business_name character varying(255) NULL,
  city character varying(100) NULL,
  location character varying(255) NULL,      -- Duplicate of city

  -- Professional Information
  specialization text NULL,
  experience_years character varying(20) NULL,  -- VARCHAR like "4-5"
  years_experience integer NULL DEFAULT 0,      -- INTEGER like 5

  -- Pricing
  pricing_per_session numeric(10, 2) NULL DEFAULT 500.00,

  -- Availability (JSONB)
  available_days jsonb NULL DEFAULT '[]'::jsonb,
  preferred_time_slots character varying(50) NULL,

  -- Services (JSONB)
  services_offered jsonb NULL DEFAULT '[]'::jsonb,
  pricing_flexibility jsonb NULL DEFAULT '[]'::jsonb,

  -- Preferences (JSONB)
  notification_preferences jsonb NULL DEFAULT '[]'::jsonb,

  -- Consent
  terms_accepted boolean NULL DEFAULT false,
  marketing_consent boolean NULL DEFAULT false,

  -- Notes
  additional_notes text NULL,

  -- Status
  status character varying(20) NULL DEFAULT 'active',

  -- Subscription
  subscription_status character varying(50) NULL DEFAULT 'free',
  subscription_expires_at timestamp with time zone NULL,
  subscription_end timestamp with time zone NULL,

  -- Registration Metadata
  registration_method character varying(20) NULL DEFAULT 'text',
  onboarding_method character varying(20) NULL DEFAULT 'chat',
  flow_token character varying(255) NULL,

  -- Timestamps
  created_at timestamp with time zone NULL DEFAULT now(),
  updated_at timestamp with time zone NULL DEFAULT now(),

  -- Constraints
  CONSTRAINT trainers_pkey PRIMARY KEY (id),
  CONSTRAINT trainers_trainer_id_key UNIQUE (trainer_id),
  CONSTRAINT trainers_whatsapp_key UNIQUE (whatsapp),
  CONSTRAINT trainers_email_key UNIQUE (email),

  -- Check Constraints
  CONSTRAINT trainers_status_check CHECK (
    status IN ('active', 'inactive', 'suspended')
  ),
  CONSTRAINT trainers_onboarding_method_check CHECK (
    onboarding_method IN ('chat', 'flow')
  ),
  CONSTRAINT trainers_subscription_status_check CHECK (
    subscription_status IN ('free', 'premium', 'pro', 'professional')
  )
);

-- Indexes
CREATE INDEX idx_trainers_whatsapp ON trainers (whatsapp);
CREATE INDEX idx_trainers_email ON trainers (lower(email));
CREATE INDEX idx_trainers_status ON trainers (status);
CREATE INDEX idx_trainers_city ON trainers (city);
CREATE INDEX idx_trainers_specialization ON trainers (specialization);
CREATE INDEX idx_trainers_onboarding_method ON trainers (onboarding_method);
CREATE INDEX idx_trainers_registration_method ON trainers (registration_method);
CREATE INDEX idx_trainers_flow_token ON trainers (flow_token);
CREATE UNIQUE INDEX idx_trainers_trainer_id ON trainers (trainer_id);
CREATE INDEX idx_trainers_services_offered ON trainers USING gin (services_offered jsonb_path_ops);
CREATE INDEX idx_trainers_pricing_flexibility ON trainers USING gin (pricing_flexibility jsonb_path_ops);
```

### Key Points

1. **Two ID columns:**

   - `id` (UUID) - Primary key, auto-generated
   - `trainer_id` (VARCHAR(10)) - Secondary ID like "TR_JOHN_123"

2. **Duplicate fields:**

   - `city` and `location` - Both store location
   - `experience_years` (VARCHAR) and `years_experience` (INTEGER)

3. **JSONB fields:**
   - `available_days` - Array of day names
   - `services_offered` - Array of service types
   - `pricing_flexibility` - Array of pricing options
   - `notification_preferences` - Array of preferences

---

## 2. `users` Table

```sql
CREATE TABLE public.users (
  -- Primary Key
  id uuid NOT NULL DEFAULT gen_random_uuid(),

  -- Phone Number (Unique identifier for user)
  phone_number character varying(20) NOT NULL,  -- UNIQUE

  -- Role IDs (References to trainers/clients tables)
  trainer_id character varying(10) NULL,  -- References trainers.trainer_id
  client_id character varying(10) NULL,   -- References clients.client_id

  -- Login Status
  login_status character varying(20) NULL DEFAULT NULL,

  -- Timestamps
  created_at timestamp with time zone NULL DEFAULT now(),
  updated_at timestamp with time zone NULL DEFAULT now(),

  -- Constraints
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_phone_number_key UNIQUE (phone_number),
  CONSTRAINT users_login_status_check CHECK (
    login_status IS NULL OR login_status IN ('trainer', 'client')
  )
);

-- Indexes
CREATE INDEX idx_users_phone_number ON users (phone_number);
CREATE INDEX idx_users_trainer_id ON users (trainer_id);
CREATE INDEX idx_users_client_id ON users (client_id);
CREATE INDEX idx_users_login_status ON users (login_status);
```

### Key Points

1. **trainer_id is VARCHAR(10):**

   - Should store values like "TR_JOHN_123"
   - NOT UUID!

2. **login_status:**
   - NULL = not logged in
   - 'trainer' = logged in as trainer
   - 'client' = logged in as client

---

## 3. `registration_states` Table

```sql
CREATE TABLE public.registration_states (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  phone_number character varying(20) NOT NULL,
  user_type character varying(20) NOT NULL,  -- 'trainer' or 'client'
  current_step integer DEFAULT 0,
  data jsonb DEFAULT '{}'::jsonb,
  completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),

  CONSTRAINT registration_states_pkey PRIMARY KEY (id),
  CONSTRAINT registration_states_user_type_check CHECK (
    user_type IN ('trainer', 'client')
  )
);

-- Indexes
CREATE INDEX idx_registration_states_phone ON registration_states (phone_number);
CREATE INDEX idx_registration_states_completed ON registration_states (completed);
```

### Key Points

1. **Used for chat-based registration only**
2. **Can be deprecated for trainers** after moving to flow-based
3. **Keep for clients** if they still use chat-based registration

---

## 4. `flow_tokens` Table

```sql
CREATE TABLE public.flow_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  flow_token character varying(255) NOT NULL,
  phone_number character varying(20) NOT NULL,
  flow_type character varying(50) NOT NULL,
  flow_data jsonb DEFAULT '{}'::jsonb,
  status character varying(20) DEFAULT 'active',
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),

  CONSTRAINT flow_tokens_pkey PRIMARY KEY (id)
);

-- Indexes
CREATE INDEX idx_flow_tokens_token ON flow_tokens (flow_token);
CREATE INDEX idx_flow_tokens_phone ON flow_tokens (phone_number);
CREATE INDEX idx_flow_tokens_type ON flow_tokens (flow_type);
```

### Key Points

1. **Used for flow-based registration**
2. **flow_type values:**
   - 'trainer_onboarding'
   - 'trainer_profile_edit'
   - 'client_onboarding_invitation'

---

## 5. `registration_analytics` Table

```sql
CREATE TABLE public.registration_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  phone_number character varying(20) NOT NULL,
  event_type character varying(50) NOT NULL,
  step_number integer,
  user_type character varying(20),
  error_field character varying(100),
  error_message text,
  timestamp timestamp with time zone DEFAULT now(),

  CONSTRAINT registration_analytics_pkey PRIMARY KEY (id)
);

-- Indexes
CREATE INDEX idx_registration_analytics_phone ON registration_analytics (phone_number);
CREATE INDEX idx_registration_analytics_event ON registration_analytics (event_type);
CREATE INDEX idx_registration_analytics_timestamp ON registration_analytics (timestamp);
```

### Key Points

1. **Tracks registration events:**
   - 'started'
   - 'step_completed'
   - 'validation_error'
   - 'completed'
   - 'abandoned'
   - 'system_error'
   - 'already_registered'

---

## 6. Field Mapping Reference

### Flow Fields â†’ Database Columns

| Flow Field                 | Database Column                        | Type         | Notes       |
| -------------------------- | -------------------------------------- | ------------ | ----------- |
| `first_name`               | `first_name`                           | VARCHAR      |             |
| `surname`                  | `last_name`                            | VARCHAR      |             |
| `email`                    | `email`                                | VARCHAR      | Lowercase   |
| `city`                     | `city`, `location`                     | VARCHAR      | Update both |
| `business_name`            | `business_name`                        | VARCHAR      |             |
| `specializations`          | `specialization`                       | TEXT         | Join array  |
| `experience_years`         | `experience_years`, `years_experience` | VARCHAR, INT | Update both |
| `pricing_per_session`      | `pricing_per_session`                  | NUMERIC      |             |
| `available_days`           | `available_days`                       | JSONB        | Array       |
| `preferred_time_slots`     | `preferred_time_slots`                 | VARCHAR      |             |
| `services_offered`         | `services_offered`                     | JSONB        | Array       |
| `pricing_flexibility`      | `pricing_flexibility`                  | JSONB        | Array       |
| `notification_preferences` | `notification_preferences`             | JSONB        | Array       |
| `marketing_consent`        | `marketing_consent`                    | BOOLEAN      |             |
| `terms_accepted`           | `terms_accepted`                       | BOOLEAN      |             |
| `additional_notes`         | `additional_notes`                     | TEXT         |             |

### Experience Years Conversion

| Flow Value | VARCHAR | INTEGER |
| ---------- | ------- | ------- |
| "0-1"      | "0-1"   | 1       |
| "2-3"      | "2-3"   | 3       |
| "4-5"      | "4-5"   | 5       |
| "6-10"     | "6-10"  | 8       |
| "10+"      | "10+"   | 12      |

---

## 7. Common Queries

### Get Trainer by Phone

```sql
-- Using whatsapp column (recommended)
SELECT * FROM trainers WHERE whatsapp = '27123456789';

-- Using users table join
SELECT t.*
FROM trainers t
JOIN users u ON t.trainer_id = u.trainer_id
WHERE u.phone_number = '27123456789';
```

### Get Trainer by ID

```sql
-- Using UUID (trainers.id)
SELECT * FROM trainers WHERE id = 'uuid-here';

-- Using VARCHAR ID (trainers.trainer_id)
SELECT * FROM trainers WHERE trainer_id = 'TR_JOHN_123';
```

### Check User Roles

```sql
SELECT
  phone_number,
  trainer_id IS NOT NULL as is_trainer,
  client_id IS NOT NULL as is_client,
  login_status
FROM users
WHERE phone_number = '27123456789';
```

---

## 8. Important Notes for Developers

1. **Always use `trainers.trainer_id` (VARCHAR) for queries from `users` table**
2. **Update both `city` and `location` when changing location**
3. **Update both `experience_years` and `years_experience` when changing experience**
4. **Store phone numbers without `+` prefix**
5. **Store emails in lowercase**
6. **JSONB arrays should be proper JSON arrays, not strings**

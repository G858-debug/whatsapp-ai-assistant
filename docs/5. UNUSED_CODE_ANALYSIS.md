# ðŸ—‘ï¸ Unused Code Analysis

## Overview

This document identifies code that is either unused, duplicate, or can be removed after consolidating to flow-based trainer registration.

---

## 1. `services/registration/` Folder Analysis

### Files in Folder

| File                            | Lines | Status       | Recommendation |
| ------------------------------- | ----- | ------------ | -------------- |
| `__init__.py`                   | 15    | Used         | Update imports |
| `trainer_registration.py`       | 681   | âš ï¸ Duplicate | **DELETE**     |
| `client_registration.py`        | ~400  | âœ… Active    | Keep           |
| `registration_state.py`         | 250   | âš ï¸ Duplicate | **DELETE**     |
| `edit_handlers.py`              | ~150  | â“ Check     | Review usage   |
| `duplicate_handler.py`          | ~100  | â“ Check     | Review usage   |
| `registration_cleaner.py`       | ~80   | â“ Check     | Review usage   |
| `registration_error_handler.py` | ~60   | â“ Check     | Review usage   |
| `registration_analytics.py`     | ~200  | âœ… Active    | Keep           |

### Detailed Analysis

#### `trainer_registration.py` - **DELETE**

**Reason:** Replaced by `services/flows/whatsapp_flow_trainer_onboarding.py`

**Current Usage Found:**

```
services/whatsapp_flow_handler.py (line 223, 1117)
  - Used as fallback when flow fails
  - Can be removed after flow is stable

services/refiloe.py (line 545)
  - Legacy code, should be removed

app_core.py (line 58)
  - Initializes handler but not used in main flow

scripts/test_enhanced_registration.py (line 42, 193)
  - Test file, update or remove
```

**Action:** Delete file, update all imports to remove references.

---

#### `registration_state.py` - **DELETE**

**Reason:** Only used by chat-based registration which is being removed.

**Current Usage Found:**

```
services/whatsapp_flow_handler.py (line 238, 1118)
  - Used with chat-based fallback
  - Remove when removing fallback

services/refiloe.py (line 546)
  - Legacy code

scripts/test_enhanced_registration.py (line 41)
  - Test file
```

**Action:** Delete file, update all imports.

---

#### `edit_handlers.py` - **REVIEW**

**Check if used by:**

- Profile edit flow
- Any other service

**Search Results:**

```python
# In services/registration/__init__.py
from .edit_handlers import EditHandlers
```

**Action:** Check if `EditHandlers` class is imported/used anywhere else. If not, delete.

---

#### `duplicate_handler.py` - **REVIEW**

**Purpose:** Handles duplicate registration attempts

**Action:** Check if this logic is needed. If flow handles duplicates, delete.

---

#### `registration_cleaner.py` - **REVIEW**

**Purpose:** Cleans up incomplete registrations

**Action:** May still be useful for cleanup tasks. Review and decide.

---

#### `registration_error_handler.py` - **REVIEW**

**Purpose:** Handles registration errors

**Action:** Check if flow has its own error handling. If yes, delete.

---

## 2. Duplicate `TrainerRegistrationHandler` Classes

### Location 1: `services/registration/trainer_registration.py`

```python
class TrainerRegistrationHandler:
    """Handle trainer registration with delightful experience"""

    def __init__(self, supabase_client, whatsapp_service=None):
        # Chat-based registration
        self.STEPS = {
            0: {'field': 'name', 'prompt': self._get_name_prompt},
            1: {'field': 'business_name', 'prompt': self._get_business_prompt},
            # ... 7 steps
        }

    def start_registration(self, phone):
        # Starts chat-based registration

    def handle_registration_response(self, phone, message, step, data):
        # Handles each chat step

    def _complete_registration(self, phone, data):
        # Saves to database
```

**Status:** âš ï¸ DELETE - Replaced by flow

---

### Location 2: `services/flows/registration/trainer_registration.py`

```python
class TrainerRegistrationHandler:
    """Handles trainer registration flow"""

    def __init__(self, db, whatsapp, reg_service, validator, message_builder, task_manager):
        # Different signature!

    def start_trainer_registration(self, phone, fields, task_id):
        # Different method name!

    def continue_trainer_registration(self, phone, message, task):
        # Different method name!
```

**Status:** âš ï¸ CONFUSING - Same class name, different implementation

**Action:** This is used by `RegistrationFlowHandler` for chat-based flow. Consider:

1. Rename to `ChatTrainerRegistrationHandler`
2. Or remove if not needed

---

## 3. Legacy Code in `services/refiloe.py`

### Lines to Remove (~lines 544-680)

```python
# Around line 544-680
if registration_type == 'trainer':
    try:
        from services.registration.trainer_registration import TrainerRegistrationHandler
        from services.registration.registration_state import RegistrationStateManager

        # Initialize handlers
        reg_handler = TrainerRegistrationHandler(self.db, whatsapp_service)
        state_manager = RegistrationStateManager(self.db)

        # ... legacy registration logic
```

**Action:** Remove this entire block after confirming flow-based registration works.

---

### Lines to Remove (~lines 2071-2092)

```python
# Around line 2071
if 'register_trainer' in message.lower():
    from services.registration.trainer_registration import TrainerRegistration
    reg = TrainerRegistration(self.db)
    reg_result = reg.start_registration(phone)
```

**Action:** Remove - this is old code using non-existent class name.

---

## 4. Fallback Code in `services/whatsapp_flow_handler.py`

### Lines to Remove

```python
# Around line 1116-1130
def _start_text_based_registration(self, phone_number: str) -> Dict:
    """Start text-based registration as fallback"""
    try:
        from services.registration.trainer_registration import TrainerRegistrationHandler
        from services.registration.registration_state import RegistrationStateManager

        # Initialize handlers
        trainer_reg = TrainerRegistrationHandler(self.supabase, self.whatsapp_service)
        state_manager = RegistrationStateManager(self.supabase)
        # ...
```

**Action:** Remove entire `_start_text_based_registration` method.

---

### Update `send_trainer_onboarding_flow`

```python
# Current code with fallback
def send_trainer_onboarding_flow(self, phone_number: str) -> Dict:
    # Try WhatsApp Flow first
    flow_result = self._attempt_flow_sending(phone_number)

    if flow_result.get('success'):
        return flow_result

    # REMOVE THIS FALLBACK:
    fallback_result = self._start_text_based_registration(phone_number)
    # ...
```

**Action:** Remove fallback logic, just return flow error if flow fails.

---

## 5. Test Files to Update

| File                                    | Action                |
| --------------------------------------- | --------------------- |
| `scripts/test_enhanced_registration.py` | Update or delete      |
| `testing/run_full_registration_test.py` | Update for flow-based |
| `testing/run_trainer_tests.py`          | Update for flow-based |

---

## 6. Backup Files (Safe to Delete)

These are in `backups/` folder and contain old versions:

```
backups/20250920_232509/trainer_registration.py
backups/20250922_141015/trainer_registration.py
backups/20250922_142247/trainer_registration.py
backups/20250922_144121/trainer_registration.py
backups/20250922_145545/trainer_registration.py
backups/20250922_151136/trainer_registration.py
backups/20250922_153630/trainer_registration.py
backups/20250922_194247/trainer_registration.py
backups/20250922_205257/trainer_registration.py
backups/20250922_213519/trainer_registration.py
backups/20250926_155908/trainer_registration.py
```

**Action:** Keep backups for now, can delete after successful migration.

---

## 7. Summary: Files to Delete

### Definitely Delete

| File                                            | Reason              |
| ----------------------------------------------- | ------------------- |
| `services/registration/trainer_registration.py` | Replaced by flow    |
| `services/registration/registration_state.py`   | Only for chat-based |

### Review Before Deleting

| File                                                  | Check                      |
| ----------------------------------------------------- | -------------------------- |
| `services/registration/edit_handlers.py`              | Is EditHandlers used?      |
| `services/registration/duplicate_handler.py`          | Is duplicate logic needed? |
| `services/registration/registration_cleaner.py`       | Is cleanup needed?         |
| `services/registration/registration_error_handler.py` | Is error handling needed?  |

### Code Blocks to Remove

| File                                | Lines      | Description                 |
| ----------------------------------- | ---------- | --------------------------- |
| `services/refiloe.py`               | ~544-680   | Legacy trainer registration |
| `services/refiloe.py`               | ~2071-2092 | Old registration trigger    |
| `services/whatsapp_flow_handler.py` | ~1116-1180 | Text fallback method        |
| `app_core.py`                       | ~58-60     | Handler initialization      |

---

## 8. Cleanup Checklist

- [ ] Delete `services/registration/trainer_registration.py`
- [ ] Delete `services/registration/registration_state.py`
- [ ] Update `services/registration/__init__.py`
- [ ] Remove fallback from `services/whatsapp_flow_handler.py`
- [ ] Remove legacy code from `services/refiloe.py`
- [ ] Remove handler init from `app_core.py`
- [ ] Update test files
- [ ] Run full test suite
- [ ] Verify flow-based registration works end-to-end

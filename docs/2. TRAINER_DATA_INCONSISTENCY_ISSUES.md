# ðŸš¨ Trainer Data Inconsistency Issues

## Overview

This document details the specific data inconsistencies between flow-based and chat-based trainer registration, and how they affect profile view/edit functionality.

---

## Issue 1: Two Different `trainer_id` Formats

### Database Schema

```sql
-- trainers table
CREATE TABLE trainers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),  -- PRIMARY KEY (UUID)
  trainer_id character varying(10) NULL,        -- SECONDARY ID (VARCHAR)
  whatsapp character varying(20) NOT NULL,
  ...
);

-- users table
CREATE TABLE users (
  phone_number character varying(20) NOT NULL,
  trainer_id character varying(10) NULL,        -- References trainers.trainer_id (VARCHAR)
  ...
);
```

### The Problem

| Registration Method | What's Saved to `users.trainer_id` | What's Saved to `trainers.trainer_id` |
| ------------------- | ---------------------------------- | ------------------------------------- |
| **Flow-based**      | `trainers.id` (UUID)               | NULL or not set                       |
| **Chat-based**      | Generated ID like "TR_JOHN_123"    | Same generated ID                     |

### Code Evidence

**Flow-based** (`services/flows/whatsapp_flow_trainer_onboarding.py`):

```python
# Line 165-175
trainer_id = result.data[0]['id']  # Gets UUID from trainers.id
trainer_whatsapp = result.data[0]['whatsapp']

# Creates users entry with UUID
self.db.table('users').insert({
    'phone_number': trainer_whatsapp,
    'trainer_id': trainer_id,  # UUID!
    ...
}).execute()
```

**Chat-based** (`services/auth/registration/data_saver.py`):

```python
# Line 25-30
trainer_id = self.auth_service.generate_unique_id(name, 'trainer')  # "TR_JOHN_123"

trainer_data = {
    'trainer_id': trainer_id,  # VARCHAR
    ...
}

# Creates users entry with VARCHAR
self.auth_service.create_user_entry(phone, 'trainer', trainer_id)  # VARCHAR!
```

---

## Issue 2: Profile View Fails for Flow-Registered Trainers

### The Query

**File:** `services/commands/common/profile_commands.py`

```python
def handle_view_profile(phone, role, user_id, db, whatsapp, reg_service):
    # user_id comes from users.trainer_id
    table = 'trainers'
    id_column = 'trainer_id'  # This is the VARCHAR column!

    role_result = db.table(table).select('*').eq(id_column, user_id).execute()
```

### The Problem

1. For **flow-registered** trainers:

   - `users.trainer_id` = UUID (e.g., "a1b2c3d4-e5f6-...")
   - Query: `SELECT * FROM trainers WHERE trainer_id = 'a1b2c3d4-e5f6-...'`
   - `trainers.trainer_id` is NULL or different
   - **Result: No data found!**

2. For **chat-registered** trainers:
   - `users.trainer_id` = "TR_JOHN_123"
   - Query: `SELECT * FROM trainers WHERE trainer_id = 'TR_JOHN_123'`
   - `trainers.trainer_id` = "TR_JOHN_123"
   - **Result: Works correctly**

---

## Issue 3: Duplicate Field Names

### trainers Table Has Duplicate Fields

| Primary Field                | Duplicate Field              | Notes                |
| ---------------------------- | ---------------------------- | -------------------- |
| `city`                       | `location`                   | Both store location  |
| `experience_years` (VARCHAR) | `years_experience` (INTEGER) | Different types!     |
| `id` (UUID)                  | `trainer_id` (VARCHAR)       | Different ID systems |

### Code That Tries to Handle This

**File:** `services/flows/profile/edit_handler.py`

```python
# Line 180-190
if role == 'trainer':
    if field_name == 'city':
        mapped_updates['location'] = value  # Also update location
    elif field_name == 'location':
        mapped_updates['city'] = value  # Also update city
    elif field_name == 'experience_years':
        mapped_updates['years_experience'] = self._parse_experience_to_number(value)
```

This creates maintenance burden and potential for inconsistency.

---

## Issue 4: Flow-Based Registration Doesn't Set `trainer_id` VARCHAR

### Current Flow Code

**File:** `services/flows/whatsapp_flow_trainer_onboarding.py`

```python
trainer_data = {
    'whatsapp': phone_number,
    'name': full_name,
    'first_name': first_name,
    'last_name': surname,
    'email': email,
    # ... other fields
    # NOTE: trainer_id VARCHAR is NOT set!
}

result = self.db.table('trainers').insert(trainer_data).execute()
trainer_id = result.data[0]['id']  # Gets UUID
```

### What Should Happen

```python
# Generate VARCHAR trainer_id
from services.auth import AuthenticationService
auth = AuthenticationService(self.db)
varchar_trainer_id = auth.generate_unique_id(full_name, 'trainer')

trainer_data = {
    'trainer_id': varchar_trainer_id,  # Set VARCHAR ID
    'whatsapp': phone_number,
    # ... other fields
}

result = self.db.table('trainers').insert(trainer_data).execute()

# Use VARCHAR ID for users table
self.db.table('users').update({
    'trainer_id': varchar_trainer_id,  # VARCHAR, not UUID
}).eq('phone_number', phone_number).execute()
```

---

## Issue 5: Profile Edit Uses Wrong ID Column

### Current Code

**File:** `services/flows/profile/edit_handler.py`

```python
def _get_current_field_value(self, role, user_id, field_name):
    table = 'trainers' if role == 'trainer' else 'clients'
    id_column = 'trainer_id' if role == 'trainer' else 'client_id'

    result = self.db.table(table).select('*').eq(id_column, user_id).execute()
```

### The Problem

- `user_id` from `users.trainer_id` might be UUID
- Query uses `trainers.trainer_id` (VARCHAR column)
- Mismatch causes query to fail

---

## Issue 6: Account Deletion Uses Wrong ID

### Current Code

**File:** `services/auth/core/user_manager.py`

```python
def delete_user_role(self, phone, role):
    role_id = user.get(f'{role}_id')  # Gets from users.trainer_id

    table = 'trainers'
    id_column = 'trainer_id'  # VARCHAR column

    self.db.table(table).delete().eq(id_column, role_id).execute()
```

### The Problem

If `role_id` is UUID but `trainer_id` column is VARCHAR, deletion fails.

---

## ðŸ“Š Summary of Issues

| Issue                         | Severity    | Impact                    |
| ----------------------------- | ----------- | ------------------------- |
| trainer_id format mismatch    | ðŸ”´ Critical | Profile view fails        |
| Duplicate field names         | ðŸŸ¡ Medium   | Maintenance burden        |
| Flow doesn't set VARCHAR ID   | ðŸ”´ Critical | Breaks profile operations |
| Profile edit wrong column     | ðŸ”´ Critical | Edit fails                |
| Account deletion wrong column | ðŸ”´ Critical | Deletion fails            |

---

## ðŸ”§ Required Fixes

See `TRAINER_CLEANUP_PLAN.md` for the detailed fix plan.

### Quick Summary

1. **Fix flow-based registration** to generate and save VARCHAR `trainer_id`
2. **Update users table** to use VARCHAR `trainer_id` consistently
3. **Update profile queries** to use correct ID column
4. **Remove chat-based registration** to eliminate confusion
5. **Consider schema migration** to use UUID consistently (future)

# üõ†Ô∏è Trainer Registration Cleanup Plan

## Overview

This document provides a step-by-step plan to clean up the trainer registration system, remove duplicate code, and fix data inconsistencies.

---

## Phase 1: Fix Flow-Based Registration Data Saving

### Priority: üî¥ Critical

### Estimated Time: 2-3 hours

### 1.1 Update `WhatsAppFlowTrainerOnboarding.process_flow_completion()`

**File:** `services/flows/whatsapp_flow_trainer_onboarding.py`

**Current Code (Line ~140-180):**

```python
trainer_data = {
    'whatsapp': phone_number,
    'name': full_name,
    # ... other fields
    # trainer_id VARCHAR is NOT set
}

result = self.db.table('trainers').insert(trainer_data).execute()
trainer_id = result.data[0]['id']  # UUID

# Creates users entry with UUID (WRONG!)
self.db.table('users').insert({
    'trainer_id': trainer_id,  # UUID
}).execute()
```

**Fixed Code:**

```python
# Import at top of file
from services.auth import AuthenticationService

# In process_flow_completion method:
auth_service = AuthenticationService(self.db)

# Generate VARCHAR trainer_id
varchar_trainer_id = auth_service.generate_unique_id(full_name, 'trainer')

trainer_data = {
    'trainer_id': varchar_trainer_id,  # ADD THIS
    'whatsapp': phone_number,
    'name': full_name,
    # ... other fields
}

result = self.db.table('trainers').insert(trainer_data).execute()

# Use VARCHAR ID for users table
self.db.table('users').insert({
    'phone_number': phone_number,
    'trainer_id': varchar_trainer_id,  # VARCHAR, not UUID
}).execute()
```

### 1.2 Update Profile View Query

**File:** `services/commands/common/profile_commands.py`

**Current Code:**

```python
def handle_view_profile(phone, role, user_id, db, whatsapp, reg_service):
    table = 'trainers' if role == 'trainer' else 'clients'
    id_column = 'trainer_id' if role == 'trainer' else 'client_id'

    role_result = db.table(table).select('*').eq(id_column, user_id).execute()
```

**This is correct IF** `users.trainer_id` contains VARCHAR ID.

After fixing Phase 1.1, this will work correctly.

---

## Phase 2: Remove Chat-Based Trainer Registration

### Priority: üü° Medium

### Estimated Time: 2-3 hours

### 2.1 Files to Delete

| File                                                  | Reason                  |
| ----------------------------------------------------- | ----------------------- |
| `services/registration/trainer_registration.py`       | Replaced by flow-based  |
| `services/registration/registration_state.py`         | Only used by chat-based |
| `services/registration/edit_handlers.py`              | Check usage first       |
| `services/registration/duplicate_handler.py`          | Check usage first       |
| `services/registration/registration_cleaner.py`       | Check usage first       |
| `services/registration/registration_error_handler.py` | Check usage first       |

### 2.2 Update Imports

**File:** `services/registration/__init__.py`

**Current:**

```python
from .trainer_registration import TrainerRegistrationHandler
from .client_registration import ClientRegistrationHandler
from .registration_state import RegistrationStateManager
from .edit_handlers import EditHandlers

__all__ = [
    'TrainerRegistrationHandler',
    'ClientRegistrationHandler',
    'RegistrationStateManager',
    'EditHandlers'
]
```

**After Cleanup:**

```python
from .client_registration import ClientRegistrationHandler
from .registration_analytics import RegistrationAnalytics

__all__ = [
    'ClientRegistrationHandler',
    'RegistrationAnalytics'
]
```

### 2.3 Remove Fallback in WhatsApp Flow Handler

**File:** `services/whatsapp_flow_handler.py`

**Remove these imports and fallback code:**

```python
# REMOVE these imports
from services.registration.trainer_registration import TrainerRegistrationHandler
from services.registration.registration_state import RegistrationStateManager

# REMOVE _start_text_based_registration method
# REMOVE fallback logic in send_trainer_onboarding_flow
```

### 2.4 Update app_core.py

**File:** `app_core.py`

**Remove:**

```python
# REMOVE this
from services.registration.trainer_registration import TrainerRegistrationHandler
trainer_registration_handler = TrainerRegistrationHandler(supabase, whatsapp_service)
```

### 2.5 Clean Up services/refiloe.py

**File:** `services/refiloe.py`

**Remove legacy registration code (approximately lines 544-680):**

```python
# REMOVE all references to:
# - TrainerRegistrationHandler
# - RegistrationStateManager
# - Chat-based registration logic
```

---

## Phase 3: Ensure Consistent Field Mapping

### Priority: üü° Medium

### Estimated Time: 1-2 hours

### 3.1 Standardize Field Names

Create a mapping file to ensure consistency:

**New File:** `config/trainer_field_mapping.py`

```python
"""
Trainer field mapping between flow fields and database columns
"""

TRAINER_FIELD_MAPPING = {
    # Flow field ‚Üí Database column
    'first_name': 'first_name',
    'surname': 'last_name',
    'email': 'email',
    'city': 'city',  # PRIMARY - also update 'location'
    'business_name': 'business_name',
    'specialization': 'specialization',
    'experience_years': 'experience_years',  # VARCHAR - also update 'years_experience' (INT)
    'pricing_per_session': 'pricing_per_session',
    'available_days': 'available_days',
    'preferred_time_slots': 'preferred_time_slots',
    'services_offered': 'services_offered',
    'pricing_flexibility': 'pricing_flexibility',
    'notification_preferences': 'notification_preferences',
    'marketing_consent': 'marketing_consent',
    'terms_accepted': 'terms_accepted',
    'additional_notes': 'additional_notes',
}

# Fields that need dual updates
DUAL_UPDATE_FIELDS = {
    'city': 'location',
    'experience_years': 'years_experience',  # Needs conversion to INT
}

def parse_experience_to_int(experience_str: str) -> int:
    """Convert experience string to integer"""
    mapping = {
        '0-1': 1,
        '2-3': 3,
        '4-5': 5,
        '6-10': 8,
        '10+': 12,
    }
    return mapping.get(experience_str, 0)
```

### 3.2 Update Flow Completion to Use Mapping

**File:** `services/flows/whatsapp_flow_trainer_onboarding.py`

```python
from config.trainer_field_mapping import TRAINER_FIELD_MAPPING, DUAL_UPDATE_FIELDS, parse_experience_to_int

def process_flow_completion(self, flow_data, phone_number):
    # ... existing code ...

    trainer_data = {
        'trainer_id': varchar_trainer_id,
        'whatsapp': phone_number,
        'name': full_name,
        'first_name': first_name,
        'last_name': surname,
        'email': email,
        'city': city,
        'location': city,  # Dual update
        'experience_years': experience_years,
        'years_experience': parse_experience_to_int(experience_years),  # Dual update
        # ... other fields
    }
```

---

## Phase 4: Update Profile Edit to Use WhatsApp Flow

### Priority: üü¢ Low (Enhancement)

### Estimated Time: 3-4 hours

### 4.1 Create Profile Edit Flow Launcher

**File:** `services/flows/profile/flow_edit_launcher.py`

```python
"""
Launch WhatsApp Flow for profile editing
"""
from utils.logger import log_info, log_error

class ProfileEditFlowLauncher:
    def __init__(self, db, whatsapp_service):
        self.db = db
        self.whatsapp = whatsapp_service
        self.trainer_edit_flow_id = "YOUR_TRAINER_EDIT_FLOW_ID"

    def launch_trainer_edit_flow(self, phone: str, trainer_id: str) -> dict:
        """Launch trainer profile edit flow"""
        try:
            # Get current trainer data to pre-fill
            trainer = self.db.table('trainers').select('*').eq(
                'trainer_id', trainer_id
            ).execute()

            if not trainer.data:
                return {'success': False, 'error': 'Trainer not found'}

            current_data = trainer.data[0]

            # Generate flow token
            import time
            flow_token = f"trainer_profile_edit_{phone}_{int(time.time())}"

            # Save flow token with current data
            self.db.table('flow_tokens').insert({
                'flow_token': flow_token,
                'phone_number': phone,
                'flow_type': 'trainer_profile_edit',
                'flow_data': current_data,
                'status': 'active',
            }).execute()

            # Send flow message
            flow_message = {
                "messaging_product": "whatsapp",
                "to": phone,
                "type": "interactive",
                "interactive": {
                    "type": "flow",
                    "body": {"text": "Update your trainer profile"},
                    "action": {
                        "name": "flow",
                        "parameters": {
                            "flow_message_version": "3",
                            "flow_token": flow_token,
                            "flow_id": self.trainer_edit_flow_id,
                            "flow_cta": "Edit Profile",
                            "flow_action": "data_exchange"
                        }
                    }
                }
            }

            result = self.whatsapp.send_flow_message(flow_message)
            return result

        except Exception as e:
            log_error(f"Error launching profile edit flow: {str(e)}")
            return {'success': False, 'error': str(e)}
```

### 4.2 Update Profile Command to Use Flow

**File:** `services/commands/common/profile_commands.py`

```python
def handle_edit_profile(phone, role, user_id, db, whatsapp, reg_service, task_service):
    if role == 'trainer':
        # Use WhatsApp Flow for trainer profile edit
        from services.flows.profile.flow_edit_launcher import ProfileEditFlowLauncher
        launcher = ProfileEditFlowLauncher(db, whatsapp)
        result = launcher.launch_trainer_edit_flow(phone, user_id)

        if result.get('success'):
            return {
                'success': True,
                'response': 'Profile edit flow sent',
                'handler': 'edit_profile_flow_sent'
            }
        else:
            # Fallback to chat-based edit
            return _handle_chat_based_edit(phone, role, user_id, db, whatsapp, reg_service, task_service)
    else:
        # Keep chat-based for clients (or implement flow later)
        return _handle_chat_based_edit(phone, role, user_id, db, whatsapp, reg_service, task_service)
```

---

## Phase 5: Testing Checklist

### 5.1 Registration Tests

- [ ] New user sends "hi" ‚Üí sees welcome buttons
- [ ] Click "I'm a Trainer" ‚Üí receives WhatsApp Flow
- [ ] Complete flow ‚Üí trainer created in `trainers` table
- [ ] `trainers.trainer_id` has VARCHAR ID (e.g., "TR_JOHN_123")
- [ ] `users.trainer_id` has same VARCHAR ID
- [ ] Confirmation message received

### 5.2 Profile View Tests

- [ ] Trainer types `/view-profile` ‚Üí sees profile data
- [ ] All fields display correctly
- [ ] No "profile not found" errors

### 5.3 Profile Edit Tests

- [ ] Trainer types `/edit-profile` ‚Üí receives edit options
- [ ] Can edit individual fields
- [ ] Changes saved to database
- [ ] Both `city` and `location` updated together
- [ ] Both `experience_years` and `years_experience` updated together

### 5.4 Account Deletion Tests

- [ ] Trainer types `/delete-account` ‚Üí sees confirmation
- [ ] Type "YES DELETE" ‚Üí account deleted
- [ ] `trainers` record deleted
- [ ] `users.trainer_id` set to NULL
- [ ] Related data cleaned up

---

## üìÖ Implementation Timeline

| Phase | Task                      | Time    | Priority    |
| ----- | ------------------------- | ------- | ----------- |
| 1     | Fix flow data saving      | Day 1-2 | üî¥ Critical |
| 2     | Remove chat-based code    | Day 2-3 | üü° Medium   |
| 3     | Standardize field mapping | Day 3-4 | üü° Medium   |
| 4     | Flow-based profile edit   | Day 5-6 | üü¢ Low      |
| 5     | Testing                   | Day 6-7 | üî¥ Critical |

---

## üîç Files to Modify Summary

### Must Modify

| File                                                 | Changes                     |
| ---------------------------------------------------- | --------------------------- |
| `services/flows/whatsapp_flow_trainer_onboarding.py` | Fix trainer_id saving       |
| `services/registration/__init__.py`                  | Remove trainer imports      |
| `services/whatsapp_flow_handler.py`                  | Remove fallback code        |
| `app_core.py`                                        | Remove trainer handler init |

### Must Delete

| File                                            | Reason              |
| ----------------------------------------------- | ------------------- |
| `services/registration/trainer_registration.py` | Replaced by flow    |
| `services/registration/registration_state.py`   | Only for chat-based |

### Should Review

| File                                            | Check For                 |
| ----------------------------------------------- | ------------------------- |
| `services/registration/edit_handlers.py`        | Any trainer-specific code |
| `services/registration/duplicate_handler.py`    | Usage                     |
| `services/registration/registration_cleaner.py` | Usage                     |
| `services/refiloe.py`                           | Legacy registration code  |

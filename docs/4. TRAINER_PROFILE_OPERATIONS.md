# üë§ Trainer Profile Operations

## Overview

This document details how trainer profile view, edit, and account deletion work, including the code flow and identified issues.

---

## 1. Profile View (`/view-profile`)

### Code Flow

```
User types "/view-profile"
         ‚Üì
services/message_router/handlers/logged_in_user_handler.py
    ‚Üí LoggedInUserHandler.handle_logged_in_user()
         ‚Üì
services/message_router/handlers/role_command_handler.py
    ‚Üí RoleCommandHandler.handle_role_command()
         ‚Üì
services/commands/command_coordinator.py
    ‚Üí CommandCoordinator.handle_command()
         ‚Üì
services/commands/common/profile_commands.py
    ‚Üí handle_view_profile()
```

### Key Function

**File:** `services/commands/common/profile_commands.py`

```python
def handle_view_profile(phone, role, user_id, db, whatsapp, reg_service):
    # Step 1: Clean phone number
    clean_phone = phone.replace('+', '').replace('-', '').replace(' ', '')

    # Step 2: Get user data from users table
    user_result = db.table('users').select('*').eq('phone_number', clean_phone).execute()

    # Step 3: Get role-specific data
    table = 'trainers' if role == 'trainer' else 'clients'
    id_column = 'trainer_id' if role == 'trainer' else 'client_id'

    # ‚ö†Ô∏è ISSUE: user_id comes from users.trainer_id
    # If it's UUID but trainers.trainer_id is VARCHAR, this fails!
    role_result = db.table(table).select('*').eq(id_column, user_id).execute()

    # Step 4: Format and send profile
    profile_msg = _format_trainer_profile(role_data, user_id)
    whatsapp.send_message(phone, profile_msg)
```

### Profile Display Format

```
üë§ *Your Trainer Profile*

*ID:* TR_JOHN_123
*Name:* John Smith
*Email:* john@example.com
*Phone:* 27123456789
*Location:* Cape Town
*Business:* FitPro Training
*Specialization:* Weight Loss, Muscle Building
*Experience:* 4-5 years
*Price per Session:* R500
*Available Days:* Monday, Wednesday, Friday
*Preferred Time:* Morning
*Services:* Personal Training, Online Coaching

üí° Type /edit-profile to update your information
```

### Issue: Query Uses Wrong Column

**Problem:**

- `user_id` parameter comes from `users.trainer_id`
- Query: `SELECT * FROM trainers WHERE trainer_id = ?`
- If `users.trainer_id` contains UUID but `trainers.trainer_id` is VARCHAR ‚Üí **No match!**

**Fix Required:**
Either:

1. Query by `trainers.id` (UUID) instead of `trainers.trainer_id`
2. Or ensure `users.trainer_id` always contains VARCHAR ID

---

## 2. Profile Edit (`/edit-profile`)

### Code Flow

```
User types "/edit-profile"
         ‚Üì
services/commands/common/profile_commands.py
    ‚Üí handle_edit_profile()
         ‚Üì
Creates task with type='edit_profile'
         ‚Üì
Sends field selection message
         ‚Üì
User replies with field numbers
         ‚Üì
services/message_router/handlers/task_handler.py
    ‚Üí TaskHandler.continue_task()
         ‚Üì
services/flows/profile/profile_flow.py
    ‚Üí ProfileFlowHandler.continue_edit_profile()
         ‚Üì
services/flows/profile/edit_handler.py
    ‚Üí ProfileEditHandler.continue_edit_profile()
```

### Edit Flow Steps

1. **Field Selection**

   ```
   ‚úèÔ∏è *Edit Your Profile*

   *Select fields to edit:*

   1. *First Name*
      Current: John

   2. *Last Name*
      Current: Smith

   3. *Email*
      Current: john@example.com

   ...

   üìù *How to edit:*
   Reply with the numbers of fields you want to edit, separated by commas.

   *Examples:*
   ‚Ä¢ `1` - Edit only field 1
   ‚Ä¢ `1,3,5` - Edit fields 1, 3, and 5
   ‚Ä¢ `all` - Edit all fields
   ```

2. **Field Editing**

   - User enters new value for each selected field
   - Value is validated
   - Progress shown: "‚úÖ Field 1 of 3"

3. **Save Updates**
   - All changes saved to database
   - Confirmation message sent

### Key Function

**File:** `services/flows/profile/edit_handler.py`

```python
def _apply_profile_updates(self, phone, role, user_id, updates, task):
    # Map config field names to database column names
    mapped_updates = {}
    for field_name, value in updates.items():
        db_column = self.reg.map_field_to_db_column(field_name, role)
        mapped_updates[db_column] = value

        # Handle duplicate fields for trainers
        if role == 'trainer':
            if field_name == 'city':
                mapped_updates['location'] = value  # Also update location
            elif field_name == 'experience_years':
                mapped_updates['years_experience'] = self._parse_experience_to_number(value)

    # Apply updates to database
    table = 'trainers'
    id_column = 'trainer_id'  # ‚ö†Ô∏è Same issue as profile view!

    result = self.db.table(table).update(mapped_updates).eq(id_column, user_id).execute()
```

### Issue: Same ID Column Problem

The edit handler has the same issue as profile view - it queries by `trainer_id` VARCHAR column but `user_id` might be UUID.

---

## 3. Account Deletion (`/delete-account`)

### Code Flow

```
User types "/delete-account"
         ‚Üì
services/commands/common/profile_commands.py
    ‚Üí handle_delete_account()
         ‚Üì
Creates task with type='delete_account'
         ‚Üì
Sends confirmation message
         ‚Üì
User replies "YES DELETE"
         ‚Üì
services/flows/profile/deletion_handler.py
    ‚Üí AccountDeletionHandler.continue_delete_account()
         ‚Üì
services/auth/authentication_service.py
    ‚Üí AuthenticationService.delete_user_role()
         ‚Üì
services/auth/core/user_manager.py
    ‚Üí UserManager.delete_user_role()
```

### Deletion Confirmation

```
‚ö†Ô∏è *Delete Account*

Are you sure you want to delete your *Trainer* account?

*This will:*
‚Ä¢ Remove all your trainer data
‚Ä¢ Remove you from all client lists
‚Ä¢ Delete all habits you created
‚Ä¢ Remove all habit assignments

‚ö†Ô∏è Your entire account will be deleted.

*This action cannot be undone!*

Reply with:
‚Ä¢ 'YES DELETE' to confirm
‚Ä¢ 'CANCEL' or /stop to cancel
```

### Key Function

**File:** `services/auth/core/user_manager.py`

```python
def delete_user_role(self, phone, role):
    # Get user data
    user = self.check_user_exists(clean_phone)
    role_id = user.get(f'{role}_id')  # Gets users.trainer_id

    # Delete related data first
    self._delete_role_related_data(role_id, role, clean_phone)

    # Delete from role table
    table = 'trainers'
    id_column = 'trainer_id'  # ‚ö†Ô∏è Same issue!

    self.db.table(table).delete().eq(id_column, role_id).execute()

    # Update users table
    if not other_role_id:
        # Delete user completely
        self.db.table('users').delete().eq('phone_number', clean_phone).execute()
    else:
        # Just remove this role
        self.db.table('users').update({
            f'{role}_id': None
        }).eq('phone_number', clean_phone).execute()
```

### Related Data Deleted

For trainers:

- `trainer_client_list` - relationships with clients
- `client_trainer_list` - reverse relationships
- `trainer_tasks` - pending tasks
- `client_invitations` - sent invitations
- `trainer_habits` - created habits (if exists)

---

## 4. WhatsApp Flow-Based Profile Edit (Alternative)

### Existing Flow File

**File:** `whatsapp_flows/trainer_profile_edit_flow.json`

This flow can be used instead of chat-based editing for a better UX.

### How to Implement

1. When user types `/edit-profile`, send WhatsApp Flow instead of chat prompts
2. Pre-fill flow with current profile data
3. Process flow completion to update database

### Benefits

- Better mobile UX
- Form validation built-in
- Faster completion
- Consistent with registration flow

---

## 5. Summary of Issues

| Operation      | Issue                    | Severity    |
| -------------- | ------------------------ | ----------- |
| Profile View   | Wrong ID column query    | üî¥ Critical |
| Profile Edit   | Wrong ID column query    | üî¥ Critical |
| Account Delete | Wrong ID column query    | üî¥ Critical |
| All Operations | Duplicate field handling | üü° Medium   |

---

## 6. Recommended Fixes

### Option A: Fix ID Column Usage (Quick Fix)

Change all queries to use `trainers.id` (UUID) instead of `trainers.trainer_id`:

```python
# Instead of:
db.table('trainers').select('*').eq('trainer_id', user_id).execute()

# Use:
db.table('trainers').select('*').eq('id', user_id).execute()
```

And update `users.trainer_id` to store UUID.

### Option B: Ensure VARCHAR ID Consistency (Better Fix)

1. Fix flow registration to generate and save VARCHAR `trainer_id`
2. Store VARCHAR ID in `users.trainer_id`
3. Keep existing queries using `trainers.trainer_id`

This is the recommended approach as it maintains backward compatibility.

---

## 7. Files to Modify

| File                                                 | Change                             |
| ---------------------------------------------------- | ---------------------------------- |
| `services/commands/common/profile_commands.py`       | Fix ID column or ensure correct ID |
| `services/flows/profile/edit_handler.py`             | Fix ID column or ensure correct ID |
| `services/auth/core/user_manager.py`                 | Fix ID column or ensure correct ID |
| `services/flows/whatsapp_flow_trainer_onboarding.py` | Generate VARCHAR trainer_id        |

============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-7.4.2, pluggy-1.6.0 -- /opt/hostedtoolcache/Python/3.11.13/x64/bin/python
cachedir: .pytest_cache
metadata: {'Python': '3.11.13', 'Platform': 'Linux-6.11.0-1018-azure-x86_64-with-glibc2.39', 'Packages': {'pytest': '7.4.2', 'pluggy': '1.6.0'}, 'Plugins': {'anyio': '4.11.0', 'html': '4.1.1', 'json-report': '1.5.0', 'cov': '4.1.0', 'metadata': '3.1.1'}, 'CI': 'true', 'JAVA_HOME': '/usr/lib/jvm/temurin-17-jdk-amd64'}
rootdir: /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant
plugins: anyio-4.11.0, html-4.1.1, json-report-1.5.0, cov-4.1.0, metadata-3.1.1
collecting ... collected 66 items

tests/test_conversation_flows.py::TestBasicFunctionality::test_imports_work PASSED
tests/test_conversation_flows.py::TestBasicFunctionality::test_mock_message PASSED
tests/test_conversation_flows.py::TestBasicFunctionality::test_trainer_registration_mock PASSED
tests/test_conversation_flows.py::TestPhase1_Registration::test_basic_setup PASSED
tests/test_conversation_flows.py::TestPhase1_Registration::test_mock_registration_flow PASSED
tests/test_debug.py::test_python_version Python version: 3.11.13 (main, Jun  4 2025, 04:12:12) [GCC 13.3.0]
PASSED
tests/test_debug.py::test_can_import_basic_modules ✅ pytest imported successfully
✅ json imported successfully
PASSED
tests/test_debug.py::test_project_structure Current directory: /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant
Directory contents: ['nixpacks.toml', 'apply-fixes.log', 'models', 'requirements.txt', 'summary.txt', '.git', 'fix_test_issues.py', 'utils', 'payfast_webhook.py', 'test-output.log', 'services', '.github', 'claude_response.md', 'claude.md', 'static', 'app_routes.py', 'test_railway_api.py', 'voice_helpers.py', '__pycache__', 'fix-generator.log', 'backups', '.gitignore', '.test_failure_history.json', 'README.md', 'payment_manager.py', '.claude-config.json', 'routes', 'test-results.json', 'test-report.html', 'Procfile', 'tests', 'payment_integration.py', 'debug_time.py', 'config.py', 'app.py', 'app_core.py', 'templates', 'comment.txt', 'runtime.txt', 'supabase']
✅ services/ directory exists
   Contents: ['payment_commands.py', 'text_variation_handler.py', 'helpers', 'calendar_service.py', 'refiloe_handlers.py']...
✅ utils/ directory exists
   Contents: ['phone_utils.py', 'logger.py', 'rate_limiter.py', 'railway_api.py', '__pycache__']...
PASSED
tests/test_debug.py::test_can_import_refiloe_modules ✅ services.refiloe imported successfully
✅ services.ai_intent_handler imported successfully
✅ services.registration.trainer_registration imported successfully
✅ utils.logger imported successfully
✅ config imported successfully
PASSED
tests/test_debug.py::test_check_requirements ✅ flask is installed
✅ supabase is installed
✅ anthropic is installed
✅ pytz is installed
✅ requests is installed
PASSED
tests/test_integration_real.py::TestRealTrainerRegistration::test_real_ai_response ERROR
tests/test_integration_real.py::TestRealTrainerRegistration::test_complete_registration_flow FAILED
tests/test_integration_real.py::TestRealTrainerRegistration::test_trainer_exists_in_database FAILED
tests/test_integration_real.py::TestRealClientManagement::test_real_ai_response ERROR
tests/test_integration_real.py::TestRealClientManagement::test_add_and_retrieve_client FAILED
tests/test_integration_real.py::TestRealScheduling::test_real_ai_response ERROR
tests/test_integration_real.py::TestRealScheduling::test_create_and_view_booking FAILED
tests/test_integration_real.py::TestRealAIResponses::test_real_ai_response ERROR
tests/test_integration_real.py::TestRealAIResponses::test_ai_understands_context FAILED
tests/test_integration_real.py::TestRealAIResponses::test_ai_handles_south_african_context FAILED
tests/test_phase1_registration.py::TestTrainerRegistrationReal::test_complete_trainer_registration_flow PASSED
tests/test_phase1_registration.py::TestTrainerRegistrationReal::test_currency_parsing_variations PASSED
tests/test_phase1_registration.py::TestTrainerRegistrationReal::test_registration_with_missing_fields PASSED
tests/test_phase1_registration.py::TestTrainerRegistrationReal::test_trainer_recognition_after_registration FAILED
tests/test_phase1_registration.py::TestClientRegistrationReal::test_client_receives_welcome_after_registration FAILED
tests/test_phase1_registration.py::TestRegistrationEdgeCases::test_duplicate_registration_attempt PASSED
tests/test_phase1_registration.py::TestRegistrationEdgeCases::test_invalid_email_format PASSED
tests/test_phase1_registration.py::TestRegistrationEdgeCases::test_extremely_long_input PASSED
tests/test_phase1_registration.py::TestRegistrationEdgeCases::test_special_characters_in_name PASSED
tests/test_phase2_client_management.py::TestAddClientReal::test_add_client_command_variations PASSED
tests/test_phase2_client_management.py::TestAddClientReal::test_phone_number_normalization PASSED
tests/test_phase2_client_management.py::TestAddClientReal::test_add_client_with_special_names PASSED
tests/test_phase2_client_management.py::TestViewClientsReal::test_view_clients_commands FAILED
tests/test_phase2_client_management.py::TestCustomPricingReal::test_set_custom_pricing_variations PASSED
tests/test_phase2_client_management.py::TestCustomPricingReal::test_check_client_pricing FAILED
tests/test_phase2_client_management.py::TestClientManagementEdgeCases::test_add_client_with_duplicate_phone FAILED
tests/test_phase2_client_management.py::TestClientManagementEdgeCases::test_invalid_phone_numbers PASSED
tests/test_phase2_client_management.py::TestClientManagementEdgeCases::test_set_negative_pricing PASSED
tests/test_phase2_client_management.py::TestClientManagementEdgeCases::test_client_not_found FAILED
tests/test_phase3_scheduling.py::TestViewScheduleReal::test_view_schedule_commands FAILED
tests/test_phase3_scheduling.py::TestBookSessionsReal::test_book_session_natural_language PASSED
tests/test_phase3_scheduling.py::TestBookSessionsReal::test_booking_time_formats PASSED
tests/test_phase3_scheduling.py::TestBookSessionsReal::test_booking_date_parsing PASSED
tests/test_phase3_scheduling.py::TestCancelRescheduleReal::test_cancel_booking_variations PASSED
tests/test_phase3_scheduling.py::TestCancelRescheduleReal::test_reschedule_booking PASSED
tests/test_phase3_scheduling.py::TestBookingConflictsAndValidation::test_double_booking_prevention PASSED
tests/test_phase3_scheduling.py::TestBookingConflictsAndValidation::test_past_date_booking_prevention PASSED
tests/test_phase3_scheduling.py::TestBookingConflictsAndValidation::test_invalid_time_slots PASSED
tests/test_refiloe_complete.py::TestPhase1_UserRegistration::test_new_trainer_onboarding PASSED
tests/test_refiloe_complete.py::TestPhase1_UserRegistration::test_trainer_recognition PASSED
tests/test_refiloe_complete.py::TestPhase2_ClientManagement::test_add_client_variations PASSED
tests/test_refiloe_complete.py::TestPhase2_ClientManagement::test_view_clients PASSED
tests/test_refiloe_complete.py::TestPhase2_ClientManagement::test_set_custom_pricing PASSED
tests/test_refiloe_complete.py::TestPhase3_SchedulingBookings::test_view_schedule PASSED
tests/test_refiloe_complete.py::TestPhase3_SchedulingBookings::test_book_sessions PASSED
tests/test_refiloe_complete.py::TestPhase3_SchedulingBookings::test_cancel_reschedule FAILED
tests/test_refiloe_complete.py::TestPhase4_HabitTracking::test_setup_habits PASSED
tests/test_refiloe_complete.py::TestPhase5_WorkoutsAssessments::test_send_workouts PASSED
tests/test_refiloe_complete.py::TestPhase6_PaymentsRevenue::test_request_payment FAILED
tests/test_refiloe_complete.py::TestPhase6_PaymentsRevenue::test_check_revenue PASSED
tests/test_refiloe_complete.py::TestPhase8_ClientFeatures::test_client_booking PASSED
tests/test_refiloe_complete.py::TestPhase8_ClientFeatures::test_client_habit_logging PASSED
tests/test_refiloe_complete.py::TestPhase10_AdvancedFeatures::test_natural_language_understanding PASSED
tests/test_refiloe_complete.py::TestPhase10_AdvancedFeatures::test_error_handling FAILED
tests/test_refiloe_complete.py::TestCriticalBugs::test_trainer_registration_step_7_currency_parsing PASSED
tests/test_refiloe_complete.py::TestCriticalBugs::test_ai_responds_naturally_not_rigid_commands PASSED

==================================== ERRORS ====================================
_____ ERROR at setup of TestRealTrainerRegistration.test_real_ai_response ______
file /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py, line 173
      def test_real_ai_response(self, prompt: str) -> str:
E       fixture 'prompt' not found
>       available fixtures: _xunit_setup_class_fixture_TestRealTrainerRegistration, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, cleanup_test_data, cov, doctest_namespace, extra, extras, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, include_metadata_in_junit_xml, json_metadata, metadata, mock_database_module, mock_db, mock_session_db, mock_whatsapp, monkeypatch, no_cover, pytestconfig, real_ai_handler, real_db, real_trainer_handler, real_validators, record_property, record_testsuite_property, record_xml_attribute, recwarn, reset_mocks, test_booking_data, test_client_data, test_config, test_phone_numbers, test_trainer_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py:173
_______ ERROR at setup of TestRealClientManagement.test_real_ai_response _______
file /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py, line 173
      def test_real_ai_response(self, prompt: str) -> str:
E       fixture 'prompt' not found
>       available fixtures: _xunit_setup_class_fixture_TestRealClientManagement, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, cleanup_test_data, cov, doctest_namespace, extra, extras, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, include_metadata_in_junit_xml, json_metadata, metadata, mock_database_module, mock_db, mock_session_db, mock_whatsapp, monkeypatch, no_cover, pytestconfig, real_ai_handler, real_db, real_trainer_handler, real_validators, record_property, record_testsuite_property, record_xml_attribute, recwarn, reset_mocks, test_booking_data, test_client_data, test_config, test_phone_numbers, test_trainer_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py:173
__________ ERROR at setup of TestRealScheduling.test_real_ai_response __________
file /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py, line 173
      def test_real_ai_response(self, prompt: str) -> str:
E       fixture 'prompt' not found
>       available fixtures: _xunit_setup_class_fixture_TestRealScheduling, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, cleanup_test_data, cov, doctest_namespace, extra, extras, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, include_metadata_in_junit_xml, json_metadata, metadata, mock_database_module, mock_db, mock_session_db, mock_whatsapp, monkeypatch, no_cover, pytestconfig, real_ai_handler, real_db, real_trainer_handler, real_validators, record_property, record_testsuite_property, record_xml_attribute, recwarn, reset_mocks, test_booking_data, test_client_data, test_config, test_phone_numbers, test_trainer_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py:173
_________ ERROR at setup of TestRealAIResponses.test_real_ai_response __________
file /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py, line 173
      def test_real_ai_response(self, prompt: str) -> str:
E       fixture 'prompt' not found
>       available fixtures: _xunit_setup_class_fixture_TestRealAIResponses, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, cleanup_test_data, cov, doctest_namespace, extra, extras, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, include_metadata_in_junit_xml, json_metadata, metadata, mock_database_module, mock_db, mock_session_db, mock_whatsapp, monkeypatch, no_cover, pytestconfig, real_ai_handler, real_db, real_trainer_handler, real_validators, record_property, record_testsuite_property, record_xml_attribute, recwarn, reset_mocks, test_booking_data, test_client_data, test_config, test_phone_numbers, test_trainer_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/tests/test_integration_real.py:173
=================================== FAILURES ===================================
_________ TestRealTrainerRegistration.test_complete_registration_flow __________
tests/test_integration_real.py:198: in test_complete_registration_flow
    response = self.call_refiloe_api(
tests/test_integration_real.py:166: in call_refiloe_api
    handler = AIIntentHandler()
E   TypeError: AIIntentHandler.__init__() missing 2 required positional arguments: 'config' and 'supabase_client'
_________ TestRealTrainerRegistration.test_trainer_exists_in_database __________
tests/test_integration_real.py:221: in test_trainer_exists_in_database
    trainer = self.create_test_trainer("TEST_Integration_Trainer")
tests/test_integration_real.py:126: in create_test_trainer
    result = self.supabase.table('trainers').insert(trainer_data).execute()
/opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/postgrest/_sync/request_builder.py:70: in execute
    raise APIError(r.json())
E   postgrest.exceptions.APIError: {'code': 'PGRST204', 'details': None, 'hint': None, 'message': "Could not find the 'status' column of 'trainers' in the schema cache"}
____________ TestRealClientManagement.test_add_and_retrieve_client _____________
tests/test_integration_real.py:238: in test_add_and_retrieve_client
    trainer = self.create_test_trainer()
tests/test_integration_real.py:126: in create_test_trainer
    result = self.supabase.table('trainers').insert(trainer_data).execute()
/opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/postgrest/_sync/request_builder.py:70: in execute
    raise APIError(r.json())
E   postgrest.exceptions.APIError: {'code': 'PGRST204', 'details': None, 'hint': None, 'message': "Could not find the 'status' column of 'trainers' in the schema cache"}
_______________ TestRealScheduling.test_create_and_view_booking ________________
tests/test_integration_real.py:266: in test_create_and_view_booking
    trainer = self.create_test_trainer()
tests/test_integration_real.py:126: in create_test_trainer
    result = self.supabase.table('trainers').insert(trainer_data).execute()
/opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/postgrest/_sync/request_builder.py:70: in execute
    raise APIError(r.json())
E   postgrest.exceptions.APIError: {'code': 'PGRST204', 'details': None, 'hint': None, 'message': "Could not find the 'status' column of 'trainers' in the schema cache"}
_______________ TestRealAIResponses.test_ai_understands_context ________________
tests/test_integration_real.py:300: in test_ai_understands_context
    assert response is not None
E   assert None is not None
------------------------------ Captured log call -------------------------------
ERROR    tests.test_integration_real:test_integration_real.py:185 AI API call failed: Error code: 404 - {'type': 'error', 'error': {'type': 'not_found_error', 'message': 'model: claude-3-sonnet-20241022'}, 'request_id': 'req_011CTVuJNq2PiZ7EEkjRpPSB'}
__________ TestRealAIResponses.test_ai_handles_south_african_context ___________
tests/test_integration_real.py:310: in test_ai_handles_south_african_context
    assert response is not None
E   assert None is not None
------------------------------ Captured log call -------------------------------
ERROR    tests.test_integration_real:test_integration_real.py:185 AI API call failed: Error code: 404 - {'type': 'error', 'error': {'type': 'not_found_error', 'message': 'model: claude-3-sonnet-20241022'}, 'request_id': 'req_011CTVuJSq8ZxR3ehFCxaSWB'}
___ TestTrainerRegistrationReal.test_trainer_recognition_after_registration ____
tests/test_phase1_registration.py:253: in test_trainer_recognition_after_registration
    assert 'john' in response.get('response', '').lower() or \
E   AssertionError: assert ('john' in <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'> or 'welcome' in <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'>)
E    +  where <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'> = <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'>()
E    +    where <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'> = <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>.lower
E    +      where <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'> = <built-in method get of dict object at 0x7f846a780500>('response', '')
E    +        where <built-in method get of dict object at 0x7f846a780500> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
E    +  and   <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'> = <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'>()
E    +    where <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'> = <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>.lower
E    +      where <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'> = <built-in method get of dict object at 0x7f846a780500>('response', '')
E    +        where <built-in method get of dict object at 0x7f846a780500> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
------------------------------ Captured log call -------------------------------
INFO     refiloe:logger.py:21 Background scheduler started
INFO     refiloe:logger.py:21 Routes setup complete
ERROR    refiloe:logger.py:25 Error sending WhatsApp message: Object of type MagicMock is not JSON serializable
__ TestClientRegistrationReal.test_client_receives_welcome_after_registration __
tests/test_phase1_registration.py:297: in test_client_receives_welcome_after_registration
    assert response.get('success') == True
E   assert False == True
E    +  where False = <built-in method get of dict object at 0x7f846a760900>('success')
E    +    where <built-in method get of dict object at 0x7f846a760900> = {'response': "Sorry, I'm having a bit of trouble right now. Please try again in a moment! 😊", 'success': False}.get
------------------------------ Captured log call -------------------------------
ERROR    refiloe:logger.py:25 Error getting user context: 'list' object has no attribute 'get'
ERROR    refiloe:logger.py:25 Error handling message: 'list' object has no attribute 'get'
________________ TestViewClientsReal.test_view_clients_commands ________________
tests/test_phase2_client_management.py:160: in test_view_clients_commands
    assert 'sarah' in message or 'john' in message or 'mike' in message or \
E   AssertionError: Failed to list clients with command: Show my clients
E   assert ('sarah' in '' or 'john' in '' or 'mike' in '' or 'client' in '')
------------------------------ Captured log call -------------------------------
ERROR    refiloe:logger.py:25 Error getting user context: Mock.keys() returned a non-iterable (type Mock)
ERROR    refiloe:logger.py:25 Error getting conversation history: 'Mock' object is not reversible
ERROR    refiloe:logger.py:25 Error sending WhatsApp message: Object of type MagicMock is not JSON serializable
_______________ TestCustomPricingReal.test_check_client_pricing ________________
tests/test_phase2_client_management.py:239: in test_check_client_pricing
    assert 'r' in message or 'rand' in message or \
E   AssertionError: Failed to show pricing with: What is Sarah's rate?
E   assert ('r' in '' or 'rand' in '' or False)
E    +  where False = any(<generator object TestCustomPricingReal.test_check_client_pricing.<locals>.<genexpr> at 0x7f846a7d1000>)
------------------------------ Captured log call -------------------------------
ERROR    refiloe:logger.py:25 Error getting user context: object of type 'Mock' has no len()
ERROR    refiloe:logger.py:25 Error getting conversation history: 'Mock' object is not reversible
ERROR    refiloe:logger.py:25 Error sending WhatsApp message: Object of type MagicMock is not JSON serializable
______ TestClientManagementEdgeCases.test_add_client_with_duplicate_phone ______
tests/test_phase2_client_management.py:268: in test_add_client_with_duplicate_phone
    assert 'already' in response.get('message', '').lower() or \
E   AssertionError: assert ('already' in '' or 'exists' in '')
E    +  where '' = <built-in method lower of str object at 0x7f847e53fba0>()
E    +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
E    +      where '' = <built-in method get of dict object at 0x7f846a5bbac0>('message', '')
E    +        where <built-in method get of dict object at 0x7f846a5bbac0> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
E    +  and   '' = <built-in method lower of str object at 0x7f847e53fba0>()
E    +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
E    +      where '' = <built-in method get of dict object at 0x7f846a5bbac0>('message', '')
E    +        where <built-in method get of dict object at 0x7f846a5bbac0> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
------------------------------ Captured log call -------------------------------
ERROR    refiloe:logger.py:25 Error getting user context: object of type 'Mock' has no len()
ERROR    refiloe:logger.py:25 Error getting conversation history: 'Mock' object is not reversible
ERROR    refiloe:logger.py:25 Error sending WhatsApp message: Object of type MagicMock is not JSON serializable
_____________ TestClientManagementEdgeCases.test_client_not_found ______________
tests/test_phase2_client_management.py:311: in test_client_not_found
    assert 'not found' in response.get('message', '').lower() or \
E   assert ('not found' in '' or "doesn't exist" in '' or 'no client' in '')
E    +  where '' = <built-in method lower of str object at 0x7f847e53fba0>()
E    +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
E    +      where '' = <built-in method get of dict object at 0x7f846a6aea80>('message', '')
E    +        where <built-in method get of dict object at 0x7f846a6aea80> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
E    +  and   '' = <built-in method lower of str object at 0x7f847e53fba0>()
E    +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
E    +      where '' = <built-in method get of dict object at 0x7f846a6aea80>('message', '')
E    +        where <built-in method get of dict object at 0x7f846a6aea80> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
E    +  and   '' = <built-in method lower of str object at 0x7f847e53fba0>()
E    +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
E    +      where '' = <built-in method get of dict object at 0x7f846a6aea80>('message', '')
E    +        where <built-in method get of dict object at 0x7f846a6aea80> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
------------------------------ Captured log call -------------------------------
ERROR    refiloe:logger.py:25 Error getting conversation history: 'Mock' object is not reversible
ERROR    refiloe:logger.py:25 Error creating conversation state: 'Mock' object is not subscriptable
ERROR    refiloe:logger.py:25 Error sending WhatsApp message: Object of type MagicMock is not JSON serializable
_______________ TestViewScheduleReal.test_view_schedule_commands _______________
tests/test_phase3_scheduling.py:74: in test_view_schedule_commands
    assert 'schedule' in message or 'booking' in message or \
E   AssertionError: Failed to show schedule with: Show my schedule
E   assert ('schedule' in '' or 'booking' in '' or 'session' in '' or 'appointment' in '' or 'no bookings' in '' or 'free' in '')
------------------------------ Captured log call -------------------------------
ERROR    refiloe:logger.py:25 Error getting user context: Mock.keys() returned a non-iterable (type Mock)
ERROR    refiloe:logger.py:25 Error getting conversation history: 'Mock' object is not reversible
ERROR    refiloe:logger.py:25 Error sending WhatsApp message: Object of type MagicMock is not JSON serializable
_____________ TestPhase3_SchedulingBookings.test_cancel_reschedule _____________
tests/test_refiloe_complete.py:329: in test_cancel_reschedule
    assert "reschedul" in response['message'].lower() or "moved" in response['message'].lower()
E   assert ('reschedul' in "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe" or 'moved' in "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe")
E    +  where "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe" = <built-in method lower of str object at 0x7f847aa61b50>()
E    +    where <built-in method lower of str object at 0x7f847aa61b50> = "Today's schedule:\n9:00 AM - Sarah Johnson\n2:00 PM - John Doe".lower
E    +  and   "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe" = <built-in method lower of str object at 0x7f847aa61b50>()
E    +    where <built-in method lower of str object at 0x7f847aa61b50> = "Today's schedule:\n9:00 AM - Sarah Johnson\n2:00 PM - John Doe".lower
_______________ TestPhase6_PaymentsRevenue.test_request_payment ________________
tests/test_refiloe_complete.py:368: in test_request_payment
    assert "payment" in response['message'].lower() or "invoice" in response['message'].lower()
E   assert ('payment' in "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?" or 'invoice' in "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?")
E    +  where "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?" = <built-in method lower of str object at 0x7f847aa2b370>()
E    +    where <built-in method lower of str object at 0x7f847aa2b370> = "Welcome to Refiloe! I'm here to help you manage your personal training business. Are you a trainer or a client?".lower
E    +  and   "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?" = <built-in method lower of str object at 0x7f847aa2b370>()
E    +    where <built-in method lower of str object at 0x7f847aa2b370> = "Welcome to Refiloe! I'm here to help you manage your personal training business. Are you a trainer or a client?".lower
_______________ TestPhase10_AdvancedFeatures.test_error_handling _______________
tests/test_refiloe_complete.py:424: in test_error_handling
    assert any(word in response['message'].lower() for word in ["past", "future", "cannot"])
E   assert False
E    +  where False = any(<generator object TestPhase10_AdvancedFeatures.test_error_handling.<locals>.<genexpr> at 0x7f846a7d11c0>)
=============================== warnings summary ===============================
../../../../../opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/gotrue/types.py:679: 19 warnings
  /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/gotrue/types.py:679: PydanticDeprecatedSince20: The `update_forward_refs` method is deprecated; use `model_rebuild` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    model.update_forward_refs()

tests/test_phase1_registration.py::TestTrainerRegistrationReal::test_trainer_recognition_after_registration
  /home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/services/analytics.py:7: DeprecationWarning: 
  Pyarrow will become a required dependency of pandas in the next major release of pandas (pandas 3.0),
  (to allow more performant data types, such as the Arrow string type, and better interoperability with other libraries)
  but was not found to be installed on your system.
  If this would cause problems for you,
  please provide us feedback at https://github.com/pandas-dev/pandas/issues/54466
          
    import pandas as pd

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
--------------------------------- JSON report ----------------------------------
report saved to: test-results.json
- Generated html report: file:///home/runner/work/whatsapp-ai-assistant/whatsapp-ai-assistant/test-report.html -
=========================== short test summary info ============================
FAILED tests/test_integration_real.py::TestRealTrainerRegistration::test_complete_registration_flow - TypeError: AIIntentHandler.__init__() missing 2 required positional arguments: 'config' and 'supabase_client'
FAILED tests/test_integration_real.py::TestRealTrainerRegistration::test_trainer_exists_in_database - postgrest.exceptions.APIError: {'code': 'PGRST204', 'details': None, 'hint': None, 'message': "Could not find the 'status' column of 'trainers' in the schema cache"}
FAILED tests/test_integration_real.py::TestRealClientManagement::test_add_and_retrieve_client - postgrest.exceptions.APIError: {'code': 'PGRST204', 'details': None, 'hint': None, 'message': "Could not find the 'status' column of 'trainers' in the schema cache"}
FAILED tests/test_integration_real.py::TestRealScheduling::test_create_and_view_booking - postgrest.exceptions.APIError: {'code': 'PGRST204', 'details': None, 'hint': None, 'message': "Could not find the 'status' column of 'trainers' in the schema cache"}
FAILED tests/test_integration_real.py::TestRealAIResponses::test_ai_understands_context - assert None is not None
FAILED tests/test_integration_real.py::TestRealAIResponses::test_ai_handles_south_african_context - assert None is not None
FAILED tests/test_phase1_registration.py::TestTrainerRegistrationReal::test_trainer_recognition_after_registration - AssertionError: assert ('john' in <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'> or 'welcome' in <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'>)
 +  where <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'> = <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'>()
 +    where <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'> = <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>.lower
 +      where <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'> = <built-in method get of dict object at 0x7f846a780500>('response', '')
 +        where <built-in method get of dict object at 0x7f846a780500> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
 +  and   <MagicMock name='AIIntentHandler().generate_smart_response().lower()' id='140206698813712'> = <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'>()
 +    where <MagicMock name='AIIntentHandler().generate_smart_response().lower' id='140206698807632'> = <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>.lower
 +      where <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'> = <built-in method get of dict object at 0x7f846a780500>('response', '')
 +        where <built-in method get of dict object at 0x7f846a780500> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
FAILED tests/test_phase1_registration.py::TestClientRegistrationReal::test_client_receives_welcome_after_registration - assert False == True
 +  where False = <built-in method get of dict object at 0x7f846a760900>('success')
 +    where <built-in method get of dict object at 0x7f846a760900> = {'response': "Sorry, I'm having a bit of trouble right now. Please try again in a moment! 😊", 'success': False}.get
FAILED tests/test_phase2_client_management.py::TestViewClientsReal::test_view_clients_commands - AssertionError: Failed to list clients with command: Show my clients
assert ('sarah' in '' or 'john' in '' or 'mike' in '' or 'client' in '')
FAILED tests/test_phase2_client_management.py::TestCustomPricingReal::test_check_client_pricing - AssertionError: Failed to show pricing with: What is Sarah's rate?
assert ('r' in '' or 'rand' in '' or False)
 +  where False = any(<generator object TestCustomPricingReal.test_check_client_pricing.<locals>.<genexpr> at 0x7f846a7d1000>)
FAILED tests/test_phase2_client_management.py::TestClientManagementEdgeCases::test_add_client_with_duplicate_phone - AssertionError: assert ('already' in '' or 'exists' in '')
 +  where '' = <built-in method lower of str object at 0x7f847e53fba0>()
 +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
 +      where '' = <built-in method get of dict object at 0x7f846a5bbac0>('message', '')
 +        where <built-in method get of dict object at 0x7f846a5bbac0> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
 +  and   '' = <built-in method lower of str object at 0x7f847e53fba0>()
 +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
 +      where '' = <built-in method get of dict object at 0x7f846a5bbac0>('message', '')
 +        where <built-in method get of dict object at 0x7f846a5bbac0> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
FAILED tests/test_phase2_client_management.py::TestClientManagementEdgeCases::test_client_not_found - assert ('not found' in '' or "doesn't exist" in '' or 'no client' in '')
 +  where '' = <built-in method lower of str object at 0x7f847e53fba0>()
 +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
 +      where '' = <built-in method get of dict object at 0x7f846a6aea80>('message', '')
 +        where <built-in method get of dict object at 0x7f846a6aea80> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
 +  and   '' = <built-in method lower of str object at 0x7f847e53fba0>()
 +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
 +      where '' = <built-in method get of dict object at 0x7f846a6aea80>('message', '')
 +        where <built-in method get of dict object at 0x7f846a6aea80> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
 +  and   '' = <built-in method lower of str object at 0x7f847e53fba0>()
 +    where <built-in method lower of str object at 0x7f847e53fba0> = ''.lower
 +      where '' = <built-in method get of dict object at 0x7f846a6aea80>('message', '')
 +        where <built-in method get of dict object at 0x7f846a6aea80> = {'response': <MagicMock name='AIIntentHandler().generate_smart_response()' id='140206698666320'>, 'success': True}.get
FAILED tests/test_phase3_scheduling.py::TestViewScheduleReal::test_view_schedule_commands - AssertionError: Failed to show schedule with: Show my schedule
assert ('schedule' in '' or 'booking' in '' or 'session' in '' or 'appointment' in '' or 'no bookings' in '' or 'free' in '')
FAILED tests/test_refiloe_complete.py::TestPhase3_SchedulingBookings::test_cancel_reschedule - assert ('reschedul' in "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe" or 'moved' in "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe")
 +  where "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe" = <built-in method lower of str object at 0x7f847aa61b50>()
 +    where <built-in method lower of str object at 0x7f847aa61b50> = "Today's schedule:\n9:00 AM - Sarah Johnson\n2:00 PM - John Doe".lower
 +  and   "today's schedule:\n9:00 am - sarah johnson\n2:00 pm - john doe" = <built-in method lower of str object at 0x7f847aa61b50>()
 +    where <built-in method lower of str object at 0x7f847aa61b50> = "Today's schedule:\n9:00 AM - Sarah Johnson\n2:00 PM - John Doe".lower
FAILED tests/test_refiloe_complete.py::TestPhase6_PaymentsRevenue::test_request_payment - assert ('payment' in "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?" or 'invoice' in "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?")
 +  where "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?" = <built-in method lower of str object at 0x7f847aa2b370>()
 +    where <built-in method lower of str object at 0x7f847aa2b370> = "Welcome to Refiloe! I'm here to help you manage your personal training business. Are you a trainer or a client?".lower
 +  and   "welcome to refiloe! i'm here to help you manage your personal training business. are you a trainer or a client?" = <built-in method lower of str object at 0x7f847aa2b370>()
 +    where <built-in method lower of str object at 0x7f847aa2b370> = "Welcome to Refiloe! I'm here to help you manage your personal training business. Are you a trainer or a client?".lower
FAILED tests/test_refiloe_complete.py::TestPhase10_AdvancedFeatures::test_error_handling - assert False
 +  where False = any(<generator object TestPhase10_AdvancedFeatures.test_error_handling.<locals>.<genexpr> at 0x7f846a7d11c0>)
ERROR tests/test_integration_real.py::TestRealTrainerRegistration::test_real_ai_response
ERROR tests/test_integration_real.py::TestRealClientManagement::test_real_ai_response
ERROR tests/test_integration_real.py::TestRealScheduling::test_real_ai_response
ERROR tests/test_integration_real.py::TestRealAIResponses::test_real_ai_response
============ 16 failed, 46 passed, 20 warnings, 4 errors in 58.81s =============

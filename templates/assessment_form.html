<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Assessment - {{ client_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="assessmentForm()" class="min-h-screen">
        
        <!-- Progress Bar -->
        <div class="sticky top-0 bg-white shadow-sm z-40">
            <div class="h-2 bg-gray-200">
                <div class="progress-bar h-full bg-purple-600" 
                     :style="`width: ${progress}%`"></div>
            </div>
            <div class="px-4 py-3 flex justify-between items-center">
                <h1 class="text-lg font-semibold">Fitness Assessment</h1>
                <span class="text-sm text-gray-600" x-text="`${currentSection + 1} of ${totalSections}`"></span>
            </div>
        </div>

        <!-- Form Content -->
        <div class="max-w-2xl mx-auto p-4">
            
            <!-- Welcome Section -->
            <div x-show="currentSection === 0" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-2xl font-bold mb-4">Welcome, {{ client_name }}! ðŸ‘‹</h2>
                    <p class="text-gray-600 mb-6">
                        This fitness assessment will help your trainer create the perfect program for you.
                        It should take about 10-15 minutes to complete.
                    </p>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span>Your information is kept private and secure</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span>You can save and continue later</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span>Be honest - this helps create the best program for you</span>
                        </div>
                    </div>
                    
                    <button @click="nextSection()" 
                            class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium">
                        Let's Get Started! ðŸš€
                    </button>
                </div>
            </div>

            <!-- Health Section -->
            <div x-show="currentSection === 1" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-heart-pulse mr-2"></i>
                        Health & Medical History
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Injuries Question -->
                        <div x-show="template.health.injuries">
                            <label class="block text-sm font-medium mb-2">
                                Do you have any current injuries or areas of pain?
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="has_injuries" value="no" 
                                           x-model="formData.health.has_injuries" class="mr-2">
                                    <span>No injuries or pain</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="has_injuries" value="yes" 
                                           x-model="formData.health.has_injuries" class="mr-2">
                                    <span>Yes, I have injuries/pain</span>
                                </label>
                            </div>
                            
                            <div x-show="formData.health.has_injuries === 'yes'" x-transition class="mt-3">
                                <textarea x-model="formData.health.pain_areas"
                                          placeholder="Please describe your injuries or pain areas..."
                                          class="w-full p-3 border rounded-lg" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- Medications -->
                        <div x-show="template.health.medications">
                            <label class="block text-sm font-medium mb-2">
                                Are you currently taking any medications?
                            </label>
                            <input type="text" x-model="formData.health.medications"
                                   placeholder="List medications or type 'None'"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Chronic Conditions -->
                        <div x-show="template.health.conditions">
                            <label class="block text-sm font-medium mb-2">
                                Do you have any chronic health conditions?
                            </label>
                            <input type="text" x-model="formData.health.conditions"
                                   placeholder="e.g., diabetes, high blood pressure, or 'None'"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Doctor Clearance -->
                        <div x-show="template.health.clearance">
                            <label class="block text-sm font-medium mb-2">
                                Has your doctor cleared you for exercise?
                            </label>
                            <select x-model="formData.health.doctor_clearance"
                                    class="w-full p-3 border rounded-lg">
                                <option value="">Select...</option>
                                <option value="yes">Yes, cleared for all exercise</option>
                                <option value="with_restrictions">Yes, with some restrictions</option>
                                <option value="no">No / Not sure</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lifestyle Section -->
            <div x-show="currentSection === 2" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-person-walking mr-2"></i>
                        Lifestyle & Habits
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Activity Level -->
                        <div x-show="template.lifestyle.activity">
                            <label class="block text-sm font-medium mb-2">
                                How would you describe your daily activity level?
                            </label>
                            <select x-model="formData.lifestyle.activity_level"
                                    class="w-full p-3 border rounded-lg">
                                <option value="">Select...</option>
                                <option value="sedentary">Sedentary (mostly sitting)</option>
                                <option value="light">Lightly active (some walking)</option>
                                <option value="moderate">Moderately active (on feet often)</option>
                                <option value="active">Very active (physical job)</option>
                            </select>
                        </div>

                        <!-- Sleep -->
                        <div x-show="template.lifestyle.sleep">
                            <label class="block text-sm font-medium mb-2">
                                How many hours of sleep do you get per night?
                            </label>
                            <input type="number" x-model="formData.lifestyle.sleep_hours"
                                   min="3" max="12" step="0.5"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Stress -->
                        <div x-show="template.lifestyle.stress">
                            <label class="block text-sm font-medium mb-2">
                                Rate your stress level (1-10)
                            </label>
                            <input type="range" x-model="formData.lifestyle.stress_level"
                                   min="1" max="10" class="w-full">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>Low (1)</span>
                                <span x-text="formData.lifestyle.stress_level"></span>
                                <span>High (10)</span>
                            </div>
                        </div>

                        <!-- Water Intake -->
                        <div x-show="template.lifestyle.water">
                            <label class="block text-sm font-medium mb-2">
                                How many liters of water do you drink daily?
                            </label>
                            <input type="number" x-model="formData.lifestyle.water_intake"
                                   min="0" max="6" step="0.5"
                                   class="w-full p-3 border rounded-lg">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div x-show="currentSection === 3" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-bullseye mr-2"></i>
                        Your Fitness Goals
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Primary Goal -->
                        <div x-show="template.goals.primary">
                            <label class="block text-sm font-medium mb-2">
                                What's your PRIMARY fitness goal?
                            </label>
                            <select x-model="formData.goals.primary_goal"
                                    class="w-full p-3 border rounded-lg">
                                <option value="">Select...</option>
                                <option value="weight_loss">Lose weight</option>
                                <option value="muscle_gain">Build muscle</option>
                                <option value="strength">Get stronger</option>
                                <option value="endurance">Improve endurance</option>
                                <option value="health">Better overall health</option>
                                <option value="sports">Sports performance</option>
                                <option value="rehabilitation">Rehabilitation</option>
                            </select>
                        </div>

                        <!-- Specific Targets -->
                        <div x-show="template.goals.specific">
                            <label class="block text-sm font-medium mb-2">
                                Do you have specific targets?
                            </label>
                            <textarea x-model="formData.goals.specific_targets"
                                      placeholder="e.g., 'Lose 10kg', 'Run 5km', 'Do 10 pull-ups'"
                                      class="w-full p-3 border rounded-lg" rows="3"></textarea>
                        </div>

                        <!-- Timeline -->
                        <div x-show="template.goals.timeline">
                            <label class="block text-sm font-medium mb-2">
                                In how many weeks would you like to achieve this?
                            </label>
                            <input type="number" x-model="formData.goals.timeline_weeks"
                                   min="4" max="52"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Motivation -->
                        <div x-show="template.goals.motivation">
                            <label class="block text-sm font-medium mb-2">
                                Rate your motivation level (1-10)
                            </label>
                            <input type="range" x-model="formData.goals.motivation_level"
                                   min="1" max="10" class="w-full">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>Low (1)</span>
                                <span x-text="formData.goals.motivation_level"></span>
                                <span>High (10)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Measurements Section -->
            <div x-show="currentSection === 4" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-ruler mr-2"></i>
                        Physical Measurements
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Weight -->
                        <div x-show="template.measurements.weight">
                            <label class="block text-sm font-medium mb-2">
                                Current weight (kg)
                            </label>
                            <input type="number" x-model="formData.measurements.weight_kg"
                                   min="30" max="300" step="0.1"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Height -->
                        <div x-show="template.measurements.height">
                            <label class="block text-sm font-medium mb-2">
                                Height (cm)
                            </label>
                            <input type="number" x-model="formData.measurements.height_cm"
                                   min="100" max="250"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Waist -->
                        <div x-show="template.measurements.waist">
                            <label class="block text-sm font-medium mb-2">
                                Waist circumference (cm) - Optional
                            </label>
                            <input type="number" x-model="formData.measurements.waist"
                                   min="40" max="200"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Other measurements -->
                        <div x-show="template.measurements.chest">
                            <label class="block text-sm font-medium mb-2">
                                Chest circumference (cm) - Optional
                            </label>
                            <input type="number" x-model="formData.measurements.chest"
                                   min="50" max="200"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <div x-show="template.measurements.hips">
                            <label class="block text-sm font-medium mb-2">
                                Hip circumference (cm) - Optional
                            </label>
                            <input type="number" x-model="formData.measurements.hips"
                                   min="50" max="200"
                                   class="w-full p-3 border rounded-lg">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fitness Tests Section -->
            <div x-show="currentSection === 5" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-dumbbell mr-2"></i>
                        Fitness Tests
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Do these simple tests to measure your current fitness level. Do your best but don't push too hard!
                    </p>
                    
                    <div class="space-y-6">
                        <!-- Push-ups -->
                        <div x-show="template.tests.pushups">
                            <label class="block text-sm font-medium mb-2">
                                How many push-ups can you do with good form?
                            </label>
                            <input type="number" x-model="formData.tests.push_ups_count"
                                   min="0" max="200"
                                   placeholder="Enter 0 if you can't do any yet"
                                   class="w-full p-3 border rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">You can do them on your knees if needed</p>
                        </div>

                        <!-- Plank -->
                        <div x-show="template.tests.plank">
                            <label class="block text-sm font-medium mb-2">
                                How many seconds can you hold a plank?
                            </label>
                            <input type="number" x-model="formData.tests.plank_hold_seconds"
                                   min="0" max="600"
                                   placeholder="Time in seconds"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Squats -->
                        <div x-show="template.tests.squats">
                            <label class="block text-sm font-medium mb-2">
                                How many bodyweight squats can you do?
                            </label>
                            <input type="number" x-model="formData.tests.squat_reps"
                                   min="0" max="200"
                                   placeholder="With good form"
                                   class="w-full p-3 border rounded-lg">
                        </div>

                        <!-- Cardio -->
                        <div x-show="template.tests.cardio">
                            <label class="block text-sm font-medium mb-2">
                                How do you feel after climbing 2 flights of stairs?
                            </label>
                            <select x-model="formData.tests.cardio_level"
                                    class="w-full p-3 border rounded-lg">
                                <option value="">Select...</option>
                                <option value="easy">Easy, no problem</option>
                                <option value="slightly_winded">Slightly winded</option>
                                <option value="need_rest">Need to catch my breath</option>
                                <option value="very_difficult">Very difficult</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div x-show="currentSection === 6 && template.include_photos" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-camera mr-2"></i>
                        Progress Photos (Optional)
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Photos help track your visual progress. They're completely optional and kept private.
                    </p>
                    
                    <div class="space-y-4">
                        <!-- Photo upload areas -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <label class="block">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 cursor-pointer hover:border-purple-500">
                                        <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-sm">Front View</p>
                                        <input type="file" accept="image/*" class="hidden"
                                               @change="uploadPhoto($event, 'front')">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="text-center">
                                <label class="block">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 cursor-pointer hover:border-purple-500">
                                        <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-sm">Side View</p>
                                        <input type="file" accept="image/*" class="hidden"
                                               @change="uploadPhoto($event, 'side')">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="text-center">
                                <label class="block">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 cursor-pointer hover:border-purple-500">
                                        <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-sm">Back View</p>
                                        <input type="file" accept="image/*" class="hidden"
                                               @change="uploadPhoto($event, 'back')">
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500 text-center">
                            <i class="fas fa-lock mr-1"></i>
                            Photos are encrypted and only visible to you and your trainer
                        </p>
                    </div>
                </div>
            </div>

            <!-- Review Section -->
            <div x-show="currentSection === 7" x-transition>
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        Review & Submit
                    </h2>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <p class="text-green-800 font-medium">
                            Great job completing your assessment! ðŸŽ‰
                        </p>
                        <p class="text-sm text-green-700 mt-1">
                            Your trainer will review this and create your personalized program.
                        </p>
                    </div>
                    
                    <!-- Summary of entered data -->
                    <div class="space-y-4 mb-6">
                        <div class="text-sm">
                            <span class="font-medium">Primary Goal:</span>
                            <span x-text="formData.goals.primary_goal || 'Not specified'"></span>
                        </div>
                        <div class="text-sm">
                            <span class="font-medium">Current Weight:</span>
                            <span x-text="formData.measurements.weight_kg ? formData.measurements.weight_kg + 'kg' : 'Not specified'"></span>
                        </div>
                        <div class="text-sm">
                            <span class="font-medium">Fitness Level:</span>
                            <span x-text="`Push-ups: ${formData.tests.push_ups_count || 0}, Plank: ${formData.tests.plank_hold_seconds || 0}s`"></span>
                        </div>
                    </div>
                    
                    <button @click="submitAssessment()"
                            class="w-full bg-green-600 text-white py-3 rounded-lg font-medium">
                        Submit Assessment âœ…
                    </button>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-6" x-show="currentSection > 0 && currentSection < 7">
                <button @click="previousSection()"
                        class="px-6 py-2 border border-gray-300 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back
                </button>
                
                <button @click="saveProgress()"
                        class="px-6 py-2 bg-gray-200 rounded-lg">
                    <i class="fas fa-save mr-2"></i>
                    Save Progress
                </button>
                
                <button @click="nextSection()"
                        class="px-6 py-2 bg-purple-600 text-white rounded-lg">
                    Next
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function assessmentForm() {
            return {
                currentSection: 0,
                totalSections: 8,
                progress: 0,
                
                // Template settings from backend
                template: {{ template_settings|tojson }},
                
                // Form data
                formData: {
                    health: {},
                    lifestyle: {},
                    goals: {},
                    measurements: {},
                    tests: {},
                    photos: []
                },
                
                init() {
                    // Load saved progress if any
                    this.loadProgress();
                    this.updateProgress();
                },
                
                nextSection() {
                    if (this.currentSection < this.totalSections - 1) {
                        this.currentSection++;
                        this.updateProgress();
                        this.autoSave();
                        window.scrollTo(0, 0);
                    }
                },
                
                previousSection() {
                    if (this.currentSection > 0) {
                        this.currentSection--;
                        this.updateProgress();
                        window.scrollTo(0, 0);
                    }
                },
                
                updateProgress() {
                    this.progress = ((this.currentSection + 1) / this.totalSections) * 100;
                },
                
                autoSave() {
                    // Save to localStorage
                    localStorage.setItem('assessment_progress', JSON.stringify({
                        section: this.currentSection,
                        data: this.formData
                    }));
                    
                    // Also save to backend periodically
                    if (this.currentSection % 2 === 0) {
                        this.saveToBackend();
                    }
                },
                
                saveProgress() {
                    this.saveToBackend();
                    alert('Progress saved! You can continue anytime.');
                },
                
                saveToBackend() {
                    fetch('/api/assessment/save-progress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: '{{ access_token }}',
                            data: this.formData,
                            section: this.currentSection
                        })
                    });
                },
                
                loadProgress() {
                    const saved = localStorage.getItem('assessment_progress');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.formData = data.data;
                        this.currentSection = data.section;
                    }
                },
                
                uploadPhoto(event, type) {
                    const file = event.target.files[0];
                    if (file) {
                        // Handle photo upload
                        const formData = new FormData();
                        formData.append('photo', file);
                        formData.append('type', type);
                        formData.append('token', '{{ access_token }}');
                        
                        fetch('/api/assessment/upload-photo', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                this.formData.photos.push({
                                    type: type,
                                    url: data.url
                                });
                                alert('Photo uploaded successfully!');
                            }
                        });
                    }
                },
                
                submitAssessment() {
                    if (confirm('Are you ready to submit your assessment?')) {
                        fetch('/api/assessment/submit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                token: '{{ access_token }}',
                                data: this.formData
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Clear saved progress
                                localStorage.removeItem('assessment_progress');
                                
                                // Show success message
                                this.currentSection = 8; // Success screen
                                alert('Assessment submitted successfully! Your trainer will review it soon.');
                                
                                // Redirect after 3 seconds
                                setTimeout(() => {
                                    window.location.href = '/assessment/complete';
                                }, 3000);
                            }
                        });
                    }
                }
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Assessment - {{ trainer.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js MUST load before your custom script -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --beige-light: #FFF8E8;
            --beige: #F7EED3;
            --beige-dark: #E8D5B7;
            --sage: #8B9A7B;
            --sage-dark: #6B7A5B;
            --sage-light: #A4B294;
            --text-dark: #2C2C2C;
        }
        
        /* Custom checkbox styling */
        input[type="checkbox"]:checked {
            background-color: var(--sage) !important;
            border-color: var(--sage) !important;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        input[type="checkbox"] {
            cursor: pointer;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            flex-shrink: 0;
        }
        
        input[type="checkbox"]:hover {
            border-color: var(--sage-light);
        }
        
        input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 154, 123, 0.2);
            border-color: var(--sage);
        }
        
        /* Custom radio button styling to match checkboxes */
        input[type="radio"] {
            cursor: pointer;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            flex-shrink: 0;
            position: relative;
        }
        
        input[type="radio"]:checked {
            background-color: var(--sage) !important;
            border-color: var(--sage) !important;
        }
        
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background-color: white;
        }
        
        input[type="radio"]:hover {
            border-color: var(--sage-light);
        }
        
        input[type="radio"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 154, 123, 0.2);
            border-color: var(--sage);
        }
        
        /* Button hover effects */
        .sage-button {
            background-color: var(--sage);
            color: white;
            transition: all 0.3s ease;
        }
        
        .sage-button:hover {
            background-color: var(--sage-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 122, 91, 0.3);
        }
        
        /* Make sure the save button area is visible */
        .bottom-save-area {
            z-index: 50;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="assessmentEditor()" x-init="init()" class="min-h-screen p-4 pb-32">
        
        <!-- Header with Beige Background -->
        <header class="rounded-lg mb-4 shadow-sm" style="background: linear-gradient(135deg, var(--beige) 0%, var(--beige-light) 100%);">
            <div class="px-4 py-4">
                <h1 class="text-xl font-bold" style="color: var(--text-dark);">
                    <i class="fas fa-clipboard-check mr-2"></i>
                    Customize Your Fitness Assessment
                </h1>
                <p class="text-sm mt-1" style="color: var(--text-dark); opacity: 0.8;">
                    Choose what information to collect from clients
                </p>
            </div>
        </header>

        <!-- Debug info (remove after testing) -->
        <div class="bg-yellow-100 p-2 rounded mb-4 text-xs">
            Debug: <span x-text="'Sections loaded: ' + Object.keys(sections).length"></span> |
            Questions selected: <span x-text="countSelectedQuestions()"></span>
        </div>

        <!-- Settings Section -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <h2 class="text-lg font-semibold mb-4" style="color: var(--text-dark);">Assessment Settings</h2>
            
            <div class="space-y-4">
                <!-- Who completes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Who will complete the assessment?
                    </label>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="completed_by" value="client" 
                                   x-model="settings.completed_by" class="mr-2">
                            <span>Client (on their phone)</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="completed_by" value="trainer" 
                                   x-model="settings.completed_by" class="mr-2">
                            <span>Trainer (during session)</span>
                        </label>
                    </div>
                </div>

                <!-- Frequency -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        How often should assessments be done?
                    </label>
                    <select x-model="settings.frequency" 
                            class="w-full md:w-auto px-3 py-2 border rounded-lg">
                        <option value="once">One-time only</option>
                        <option value="monthly">Every month</option>
                        <option value="quarterly">Every 3 months</option>
                        <option value="biannual">Every 6 months</option>
                        <option value="annual">Once a year</option>
                    </select>
                </div>

                <!-- Include photos -->
                <div>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="checkbox" x-model="settings.include_photos" class="mr-3">
                        <div>
                            <span class="text-sm font-medium">Allow progress photos</span>
                            <p class="text-xs text-gray-500">Clients can upload before/after photos</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Sections to Include -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <h2 class="text-lg font-semibold mb-4" style="color: var(--text-dark);">Assessment Sections</h2>
            <p class="text-sm text-gray-600 mb-4">Toggle sections on/off and customize questions</p>
            
            <div class="space-y-4">
                <!-- Health Section -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer flex-1">
                            <input type="checkbox" x-model="sections.health.enabled" class="mr-3">
                            <span class="font-medium">Health & Medical History</span>
                        </label>
                        <button @click="sections.health.expanded = !sections.health.expanded"
                                x-show="sections.health.enabled"
                                class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas text-lg transition-transform duration-200" 
                               :class="sections.health.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                    
                    <div x-show="sections.health.enabled && sections.health.expanded" 
                         x-transition
                         class="mt-4">
                        <div class="space-y-2 ml-8">
                            <template x-for="question in sections.health.questions" :key="question.id">
                                <label class="flex items-center text-sm p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="question.selected" class="mr-3">
                                    <span x-text="question.text"></span>
                                    <span class="ml-2 text-xs text-gray-500" x-show="question.required">(Core)</span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Lifestyle Section -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer flex-1">
                            <input type="checkbox" x-model="sections.lifestyle.enabled" class="mr-3">
                            <span class="font-medium">Lifestyle & Habits</span>
                        </label>
                        <button @click="sections.lifestyle.expanded = !sections.lifestyle.expanded"
                                x-show="sections.lifestyle.enabled"
                                class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas text-lg transition-transform duration-200" 
                               :class="sections.lifestyle.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                    
                    <div x-show="sections.lifestyle.enabled && sections.lifestyle.expanded" 
                         x-transition
                         class="mt-4">
                        <div class="space-y-2 ml-8">
                            <template x-for="question in sections.lifestyle.questions" :key="question.id">
                                <label class="flex items-center text-sm p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="question.selected" class="mr-3">
                                    <span x-text="question.text"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Goals Section -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer flex-1">
                            <input type="checkbox" x-model="sections.goals.enabled" class="mr-3">
                            <span class="font-medium">Fitness Goals</span>
                        </label>
                        <button @click="sections.goals.expanded = !sections.goals.expanded"
                                x-show="sections.goals.enabled"
                                class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas text-lg transition-transform duration-200" 
                               :class="sections.goals.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                    
                    <div x-show="sections.goals.enabled && sections.goals.expanded" 
                         x-transition
                         class="mt-4">
                        <div class="space-y-2 ml-8">
                            <template x-for="question in sections.goals.questions" :key="question.id">
                                <label class="flex items-center text-sm p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="question.selected" class="mr-3">
                                    <span x-text="question.text"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Measurements Section -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer flex-1">
                            <input type="checkbox" x-model="sections.measurements.enabled" class="mr-3">
                            <span class="font-medium">Physical Measurements</span>
                        </label>
                        <button @click="sections.measurements.expanded = !sections.measurements.expanded"
                                x-show="sections.measurements.enabled"
                                class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas text-lg transition-transform duration-200" 
                               :class="sections.measurements.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                    
                    <div x-show="sections.measurements.enabled && sections.measurements.expanded" 
                         x-transition
                         class="mt-4">
                        <div class="space-y-2 ml-8">
                            <template x-for="question in sections.measurements.questions" :key="question.id">
                                <label class="flex items-center text-sm p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="question.selected" class="mr-3">
                                    <span x-text="question.text"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Fitness Tests Section -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer flex-1">
                            <input type="checkbox" x-model="sections.tests.enabled" class="mr-3">
                            <span class="font-medium">Fitness Tests</span>
                        </label>
                        <button @click="sections.tests.expanded = !sections.tests.expanded"
                                x-show="sections.tests.enabled"
                                class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas text-lg transition-transform duration-200" 
                               :class="sections.tests.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                    
                    <div x-show="sections.tests.enabled && sections.tests.expanded" 
                         x-transition
                         class="mt-4">
                        <div class="space-y-2 ml-8">
                            <template x-for="question in sections.tests.questions" :key="question.id">
                                <label class="flex items-center text-sm p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="question.selected" class="mr-3">
                                    <span x-text="question.text"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button (Fixed at bottom) -->
        <div class="fixed bottom-0 left-0 right-0 bottom-save-area">
            <div class="p-4 bg-white border-t">
                <div class="max-w-4xl mx-auto flex justify-between items-center">
                    <span class="text-sm text-gray-600">
                        <span x-text="countSelectedQuestions()"></span> questions selected
                    </span>
                    <button @click="saveTemplate()" 
                            :disabled="isSaving"
                            class="sage-button px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!isSaving">Save Template</span>
                        <span x-show="isSaving">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            Saving...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function assessmentEditor() {
            return {
                isSaving: false,
                settings: {
                    completed_by: 'client',
                    frequency: 'quarterly',
                    include_photos: true
                },
                sections: {
                    health: {
                        enabled: true,
                        expanded: false,
                        questions: [
                            { id: 'injuries', text: 'Current injuries or pain?', selected: true, required: true },
                            { id: 'medications', text: 'Current medications?', selected: true },
                            { id: 'conditions', text: 'Chronic conditions?', selected: true },
                            { id: 'surgeries', text: 'Past surgeries?', selected: false },
                            { id: 'allergies', text: 'Allergies?', selected: false },
                            { id: 'clearance', text: 'Doctor clearance?', selected: true }
                        ]
                    },
                    lifestyle: {
                        enabled: true,
                        expanded: false,
                        questions: [
                            { id: 'activity', text: 'Job activity level?', selected: true },
                            { id: 'sleep', text: 'Sleep hours & quality?', selected: true },
                            { id: 'stress', text: 'Stress level?', selected: true },
                            { id: 'nutrition', text: 'Dietary habits?', selected: false },
                            { id: 'water', text: 'Water intake?', selected: false },
                            { id: 'smoking', text: 'Smoking status?', selected: false },
                            { id: 'alcohol', text: 'Alcohol consumption?', selected: false }
                        ]
                    },
                    goals: {
                        enabled: true,
                        expanded: false,
                        questions: [
                            { id: 'primary', text: 'Primary fitness goal?', selected: true, required: true },
                            { id: 'specific', text: 'Specific targets?', selected: true },
                            { id: 'timeline', text: 'Timeline?', selected: true },
                            { id: 'motivation', text: 'Motivation level?', selected: true },
                            { id: 'preferences', text: 'Exercise preferences?', selected: false },
                            { id: 'dislikes', text: 'Exercises to avoid?', selected: false }
                        ]
                    },
                    measurements: {
                        enabled: true,
                        expanded: false,
                        questions: [
                            { id: 'weight', text: 'Weight', selected: true, required: true },
                            { id: 'height', text: 'Height', selected: true, required: true },
                            { id: 'waist', text: 'Waist circumference', selected: true },
                            { id: 'chest', text: 'Chest circumference', selected: false },
                            { id: 'hips', text: 'Hip circumference', selected: false },
                            { id: 'arms', text: 'Arm measurements', selected: false },
                            { id: 'thighs', text: 'Thigh measurements', selected: false },
                            { id: 'bodyfat', text: 'Body fat percentage', selected: false }
                        ]
                    },
                    tests: {
                        enabled: true,
                        expanded: false,
                        questions: [
                            { id: 'pushups', text: 'Push-ups test', selected: true },
                            { id: 'plank', text: 'Plank hold test', selected: true },
                            { id: 'squats', text: 'Squats test', selected: true },
                            { id: 'cardio', text: 'Cardio fitness', selected: false },
                            { id: 'flexibility', text: 'Flexibility tests', selected: false },
                            { id: 'balance', text: 'Balance tests', selected: false }
                        ]
                    }
                },
                
                init() {
                    console.log('Alpine initialized');
                    // Parse existing settings if provided by the server
                    try {
                        const existingSettings = {{ template_settings|default('{}')|safe }};
                        if (existingSettings && Object.keys(existingSettings).length > 0) {
                            this.settings.completed_by = existingSettings.completed_by || 'client';
                            this.settings.frequency = existingSettings.frequency || 'quarterly';
                            this.settings.include_photos = existingSettings.include_photos !== false;
                            
                            // Update enabled sections
                            this.sections.health.enabled = existingSettings.include_health !== false;
                            this.sections.lifestyle.enabled = existingSettings.include_lifestyle !== false;
                            this.sections.goals.enabled = existingSettings.include_goals !== false;
                            this.sections.measurements.enabled = existingSettings.include_measurements !== false;
                            this.sections.tests.enabled = existingSettings.include_tests !== false;
                        }
                    } catch (error) {
                        console.error('Error loading existing settings:', error);
                    }
                },
                
                countSelectedQuestions() {
                    let count = 0;
                    for (let section in this.sections) {
                        if (this.sections[section].enabled) {
                            count += this.sections[section].questions.filter(q => q.selected).length;
                        }
                    }
                    return count;
                },
                
                saveTemplate() {
                    if (this.isSaving) return;
                    
                    this.isSaving = true;
                    
                    // Prepare template data
                    const templateData = {
                        settings: this.settings,
                        sections: {}
                    };
                    
                    // Collect selected questions
                    for (let key in this.sections) {
                        if (this.sections[key].enabled) {
                            templateData.sections[key] = this.sections[key].questions
                                .filter(q => q.selected)
                                .map(q => q.id);
                        }
                    }
                    
                    console.log('Saving template:', templateData);
                    
                    // Send to backend
                    fetch('/api/assessment-template/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(templateData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.isSaving = false;
                        if (data.success) {
                            // Show success message
                            this.showNotification('Template saved successfully!', 'success');
                            
                            // Redirect after 2 seconds
                            setTimeout(() => {
                                window.location.href = window.location.href.replace('/assessment-settings', '');
                            }, 2000);
                        } else {
                            this.showNotification(data.error || 'Error saving template. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        this.isSaving = false;
                        console.error('Error:', error);
                        this.showNotification('Error saving template. Please try again.', 'error');
                    });
                },
                
                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50`;
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }
        }
    </script>
</body>
</html>
